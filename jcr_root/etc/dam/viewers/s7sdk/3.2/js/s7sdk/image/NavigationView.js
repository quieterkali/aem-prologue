/*!************************************************************************
*
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2011 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by trade secret or copyright law.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(function(b){b.pkg("s7sdk.image");b.Util.require("s7sdk.event.Event");if(!b.image.NavigationViewControl){b.image.NavigationViewControl=function(c){arguments.callee.superclass.apply(this,[c,b.image.NavigationViewControl.NS,c.constructor,b.image.NavigationView.RESTRICTED_STYLES])};b.image.NavigationViewControl.NS="s7sdk.image.NavigationViewControl";b.image.NavigationViewControl.prototype.rebuild=function(c){if(this.component){var d=this.component.viewPort;this.superproto.rebuild.apply(this,[c]);if(!this.component){b.Logger.log(b.Logger.ERROR,"Cannot reconstruct NavigationView");return}this.component.setViewPort(d)}}}b.Class.inherits(b.image.NavigationViewControl.NS,"s7sdk.ControlComponent");if(!b.image.NavigationView){b.image.NavigationView=function NavigationView(c,e,d){var f=!!arguments[3];b.Logger.log(b.Logger.CONFIG,"s7sdk.image.NavigationView constructor - container: %0, settings: %1 , compId: %2",c,e,d);arguments.callee.superclass.apply(this,[d,c,"div","s7navigationview",e]);this.container=this.getParent();this.initialized=false;this.mouseDown=false;this.viewPort=new b.Rectangle(0,0,0,0);this.devicePixelRatio=window.devicePixelRatio||1;if(this.navSize.width==0||this.navSize.height==0){this.navSize.width=parseInt(b.Util.css.getCss("s7navigationview","width",d,null,this.container));this.navSize.height=parseInt(b.Util.css.getCss("s7navigationview","height",d,null,this.container));if(!b.Util.isNumber(this.navSize.width)||!b.Util.isNumber(this.navSize.height)||this.navSize.width<=0||this.navSize.height<=0){this.navSize.width=128;this.navSize.height=128}}if(this.serverUrl.lastIndexOf("/")!=(this.serverUrl.length-1)){this.serverUrl+="/"}this.asset=unescape(this.asset);this.locale=this.getParam("locale","");this.imageModifier=b.MediaSetParser.parseAssetForSetReq(this.asset).mod;this.transparent=((this.fmt.indexOf("png")!=-1||this.fmt.indexOf("gif")!=-1)&&(this.fmt.indexOf("-alpha")>0))?true:false;this.dragAspect=null;this.div=this.createElement();this.div.style.position="absolute";this.div.style.width=this.navSize.width+"px";this.div.style.height=this.navSize.height+"px";this.imageDiv=document.createElement("div");this.imageDiv.style.position="absolute";this.navBox=b.Util.createElement("div");this.navBox.style.position="absolute";this.navBox.className="s7highlight";this.div.appendChild(this.imageDiv);this.div.appendChild(this.navBox);this.attachToContainer();this.pad=null;this.img=new Image();this.img.onload=b.Util.wrapContext(function(){b.Logger.log(b.Logger.INFO,"s7sdk.image.NavigationView.onload - src: %0",this.img.src);this.imageDiv.style.backgroundImage="url('"+this.img.src+"')";this.imageDiv.style.width=this.img.width+"px";this.imageDiv.style.height=this.img.height+"px";if(this.resizable==1){this.offsetX=0;this.offsetY=0;this.div.style.width=this.img.width+"px";this.div.style.height=this.img.height+"px";this.imageDiv.style.left=this.offsetX+"px";this.imageDiv.style.top=this.offsetY+"px"}else{this.offsetX=(this.navSize.width-this.img.width)/2;this.offsetY=(this.navSize.height-this.img.height)/2;this.imageDiv.style.left=this.offsetX+"px";this.imageDiv.style.top=this.offsetY+"px"}this.dragAspect=this.img.width/this.img.height;this.viewToImage=new b.Matrix2D(1/this.img.width,0,0,1/this.img.height,-this.offsetX/this.img.width,-this.offsetY/this.img.height);this.init();this.draw()},this);this.img.onerror=function(g){b.Logger.log(b.Logger.WARNING,"s7sdk.image.NavigationView.onerror - failed to load nav image: "+g.message)};this.img.onabort=function(g){b.Logger.log(b.Logger.WARNING,"s7sdk.image.NavigationView.onabort - aborted nav image load: "+g.message)};this.mediaSet=null;this.item=null;this.isReq=null;this.offsetX=0;this.offsetY=0;if(typeof(this.asset)=="string"&&this.asset.length>0){this.setAsset(this.asset)}if(!f){return new b.image.NavigationViewControl(this)}else{return this}};b.Class.inherits("s7sdk.image.NavigationView","s7sdk.UIComponent");b.image.NavigationView.prototype.modifiers={serverUrl:{params:["isRootPath"],defaults:["/is/image/"]},asset:{params:["asset"],defaults:[""],parseParams:false},iscommand:{params:["value"],defaults:[""],parseParams:false},resizable:{params:["enabled"],defaults:[false]},navSize:{params:["width","height"],defaults:[0,0],ranges:["0:","0:"],deprecated:true},fmt:{params:["fmt"],defaults:["jpg"],ranges:[["jpg","jpeg","png","png-alpha","gif","gif-alpha"]]}};b.image.NavigationView.prototype.setViewPort=function(c){if(this.mouseDown){return}b.Logger.log(b.Logger.FINE,"s7sdk.image.NavigationView.setViewPort - viewPort: %0",c);this.viewPort=c;this.draw()};b.image.NavigationView.prototype.setImage=function(c){b.Logger.log(b.Logger.FINE,"s7sdk.image.NavigationView.setImage - asset: %0",c);this.asset=c;var d=this.setupRequest();this.img.src=d};b.image.NavigationView.prototype.addEventListener=function(e,d,c){b.Logger.log(b.Logger.FINE,"s7sdk.image.NavigationView.addEventListener - type: %0, handler: %1, useCapture: %2",e,d.toString().substring(0,d.toString().indexOf("(")),c);this.superproto.addEventListener.apply(this,[e,d,c])};b.image.NavigationView.prototype.setupRequest=function(){var c=this.serverUrl;c+=this.asset;if(this.asset.indexOf("?")>-1){c+="&layer=comp&"}else{c+="?"}if(this.navSize.height>0&&this.navSize.width>0){c+="hei="+this.navSize.height+"&wid="+this.navSize.width+"&fit=constrain,1&"}else{if(this.navSize.height>0){c+="hei="+this.navSize.height+"&"}else{if(this.navSize.width>0){c+="wid="+this.navSize.width+"&"}else{c+="&"}}}if(b.Util.isNonEmptyString(this.iscommand)){c+=this.iscommand}c+="&fmt="+this.fmt;if(b.Util.isNonEmptyString(this.locale)){c+="&locale="+this.locale}return c};b.image.NavigationView.prototype.init=function(){if(!this.initialized){b.Event.addDOMListener(this.div,"mousedown",b.Util.wrapContext(this.onMouseDown,this),true);b.Event.addDOMListener(this.div,"touchstart",b.Util.wrapContext(this.onMouseDown,this),true);this.initialized=true}};b.image.NavigationView.prototype.onGestureStart=function(c){c=c||window.event;b.Event.preventDefault(c)};b.image.NavigationView.prototype.onMouseDown=function(c){c=c||window.event;b.Event.preventDefault(c);b.Event.stopPropagation(c);this.mouseDown=true;if(c.type=="mousedown"){this.lastX=c.clientX;this.lastY=c.clientY;this.lastStageX=c.clientX;this.lastStageY=c.clientY;b.Event.addDOMListener(this,"mousemove",b.Util.wrapContext(this.onMouseMove,this),true);b.Event.addDOMListener(this,"mouseup",b.Util.wrapContext(this.onMouseUp,this),true)}else{this.lastX=c.targetTouches[0].clientX;this.lastY=c.targetTouches[0].clientY;this.lastStageX=c.targetTouches[0].clientX;this.lastStageY=c.targetTouches[0].clientY;b.Event.addDOMListener(this,"touchmove",b.Util.wrapContext(this.onMouseMove,this),true);b.Event.addDOMListener(this,"touchend",b.Util.wrapContext(this.onMouseUp,this),true);b.Event.addDOMListener(this,"touchcancel",b.Util.wrapContext(this.onMouseUp,this),true)}if(this.getImageToView(this.viewPort).containsPoint(c.localX,c.localY)==false){this.mouseDown=false}};b.image.NavigationView.prototype.onMouseMove=function(e){e=e||window.event;b.Event.preventDefault(e);b.Event.stopPropagation(e);if(!this.mouseDown){return}var d=e.clientX;d=d<this.div.offsetLeft?this.div.offsetLeft:d;d=d>this.div.offsetLeft+this.width?this.div.offsetLeft+this.width:d;var c=e.clientY;c=c<this.div.offsetTop?this.div.offsetTop:c;c=c>this.div.offsetTop+this.height?this.div.offsetTop+this.height:c;if(e.type=="mousemove"){this.lastStageX=e.clientX;this.lastStageY=e.clientY}else{this.lastStageX=e.targetTouches[0].clientX;this.lastStageY=e.targetTouches[0].clientY}this.panView(this.lastStageX-this.lastX,this.lastStageY-this.lastY);this.lastX=this.lastStageX;this.lastY=this.lastStageY};b.image.NavigationView.prototype.onMouseUp=function(c){c=c||window.event;b.Event.preventDefault(c);b.Event.stopPropagation(c);if(c.type=="mouseup"){this.lastStageX=c.clientX;this.lastStageY=c.clientY;b.Event.removeDOMListener(this,"mousemove",this.onMouseMove,true);b.Event.removeDOMListener(this,"mouseup",this.onMouseUp,true)}else{if(c.targetTouches.length>0){this.lastStageX=c.targetTouches[0].clientX;this.lastStageY=c.targetTouches[0].clientY}b.Event.removeDOMListener(this,"touchmove",this.onMouseMove,true);b.Event.removeDOMListener(this,"touchend",this.onMouseUp,true);b.Event.removeDOMListener(this,"touchcancel",this.onMouseUp,true)}if(this.mouseDown==false){return}this.mouseDown=false;this.panView(this.lastStageX-this.lastX,this.lastStageY-this.lastY)};b.image.NavigationView.prototype.draw=function(){if(!this.initialized){return}var c=this.getImageToView(this.viewPort);this.drawViewPort(c)};b.image.NavigationView.prototype.drawViewPort=function(c){if(c.width>0&&c.height>0){this.positionNavBox(c)}};b.image.NavigationView.prototype.positionNavBox=function(c){if(this.pad==null){this.navBox.style.width=c.width+"px";this.navBox.style.height=c.height+"px";this.pad=this.navBox.offsetWidth-this.navBox.clientWidth}this.navBox.style.width=c.width-this.pad+"px";this.navBox.style.height=c.height-this.pad+"px";this.navBox.style.left=c.x+"px";this.navBox.style.top=c.y+"px"};b.image.NavigationView.prototype.getImageToView=function(f){var d=this.viewToImage.clone();d.invert();var c=d.transformPoint(f.topLeft());var e=d.transformPoint(f.bottomRight());return new b.Rectangle(c.x,c.y,e.x-c.x,e.y-c.y)};b.image.NavigationView.prototype.panView=function(f,d){if(f==0&&d==0){return}var c=new b.Rectangle(this.viewPort.x,this.viewPort.y,this.viewPort.width,this.viewPort.height);var h=this.getImageToView(this.viewPort);h.x+=f;h.y+=d;this.viewPort=this.viewToImage.transformRect(h);this.clampToImage(this.viewPort);this.draw();var g=new b.event.ZoomPanEvent(b.event.ZoomPanEvent.NOTF_ZOOM_NPAN,(c.x-this.viewPort.x),(c.y-this.viewPort.y));this.dispatchEvent(g)};b.image.NavigationView.prototype.clampToImage=function(c){c.x+=(c.bottomRight().x>1)?1-c.bottomRight().x:0;c.y+=(c.bottomRight().y>1)?1-c.bottomRight().y:0;c.x=(c.topLeft().x<0)?0:c.x;c.y=(c.topLeft().y<0)?0:c.y;c.width=(c.width<1)?c.width:1;c.height=(c.height<1)?c.height:1};b.image.NavigationView.prototype.hide=function(){b.Util.fade(this.obj,true,0.3,"block")};b.image.NavigationView.prototype.show=function(){b.Util.fade(this.obj,false,0.3,"block")};b.image.NavigationView.prototype.setAsset=function(c){if(typeof c!="string"){throw new Error("Asset name must be represented by a string!")}b.Logger.log(b.Logger.FINE,"s7sdk.image.NavigationView.setAsset - asset: %0",c);var f=this.asset;this.currentAsset=c;this.asset=unescape(c);this.mediaSet=null;var d=this.serverUrl+"/"+b.MediaSetParser.parseAssetForSetReq(this.asset).req;if(b.Util.isNonEmptyString(this.locale)){d+="&locale="+this.locale}if(this.isReq){this.isReq.cancelHttpReq()}this.isReq=new b.IS(this.serverUrl,this.asset);this.isReq.getHttpReq(d,function(h,g){b.image.NavigationView.prototype.loadRequest.apply(g,[h])},function(h,g){b.Logger.log(b.Logger.ERROR,"s7sdk.image.NavigationView.setAsset - failed to load asset: %0 with error message %1",c,h)},this);if(f!=this.asset&&f!=null){var e=new b.event.UserEvent(b.event.UserEvent.SWAP,[0,this.asset],true);b.Event.dispatch(this.obj,e,false)}};b.image.NavigationView.prototype.getAsset=function(){b.Logger.log(b.Logger.FINE,"s7sdk.image.NavigationView.getAsset");return this.asset};b.image.NavigationView.prototype.loadRequest=function(c){this.mediaSet=b.MediaSetParser.parse(c.set,this.imageModifier);if(this.mediaSet.items.length>0&&this.mediaSet.items[0] instanceof b.ItemDesc){this.item=this.mediaSet.items[0];this.update(this.item)}else{throw new Error("Set response did not contain valid items! Set may be empty.")}};b.image.NavigationView.prototype.setItem=function(c){b.Logger.log(b.Logger.FINE,"s7sdk.image.NavigationView.setItem - item: %0",c);if(this.isReq){this.isReq.cancelHttpReq()}if(c instanceof b.ItemDesc==false){throw new Error("Item must be a descendant of ItemDesc!")}if(c.parent==null){throw new Error("ItemDesc must be part of a parent set!")}this.currentAsset=c;this.mediaSet=c.parent;this.item=c;this.update(this.item)};b.image.NavigationView.prototype.update=function(d){this.asset=d.name;var c=this.setupRequest();this.img.src=c};b.image.NavigationView.prototype.getWidth=function(){return this.navSize.width};b.image.NavigationView.prototype.getHeight=function(){return this.navSize.height};b.image.NavigationView.prototype.resize=function(c,d){if(c>0&&d>0){this.navSize.width=c;this.navSize.height=d;this.div.style.width=this.navSize.width+"px";this.div.style.height=this.navSize.height+"px"}};b.image.NavigationView.RESTRICTED_STYLES={s7navigationview:["width","height"]};b.image.NavigationView.prototype.setCSS=function(e,d,c){if(this.isRestrictedCSSProperty(b.image.NavigationView.RESTRICTED_STYLES,d)){throw new Error("You cannot set "+e+" : "+d+" CSS property for this component ")}else{this.superproto.setCSS.apply(this,[e,d,c])}};b.image.NavigationView.prototype.setModifier=function(c){throw new Error("Trying to use setModifier on the Core class (NavigationView) is unsupported! Please refer to SDK documentation on using setModifier.")};b.image.NavigationView.prototype.dispose=function(){this.cleanUp();if(this.obj){if(this.obj.parentElement){this.obj.parentElement.removeChild(this.obj)}}};b.image.NavigationView.prototype.cleanUp=function(c){if(this.obj){b.Util.removeTags(this.obj);this.obj.style.cssText=""}};b.image.NavigationView.prototype.getCurrentAsset=function(){return typeof this.currentAsset=="undefined"?null:this.currentAsset};b.image.NavigationView.prototype.setCurrentAsset=function(c){if(typeof(c)=="string"){this.setAsset(c)}else{this.setItem(c)}};b.NavigationView=b.image.NavigationView;(function a(){var e=b.Util.css.createCssRuleText;var d=b.browser&&b.browser.name=="ie"&&b.browser.version.major>=10;var c=e(".s7navigationview",{width:"128px",height:"128px","background-color":"#FFFFFF","user-select":"none","-ms-user-select":"none","-moz-user-select":"-moz-none","-webkit-user-select":"none","-webkit-tap-highlight-color":"rgba(0,0,0,0)","-ms-touch-action":d?"none":"","touch-action":d?"none":""})+e(".s7navigationview .s7highlight",{border:"solid 1px",color:"#ff0000"});b.Util.css.addDefaultCSS(c,"NavigationView")})()}})(s7getCurrentNameSpace());