/*!************************************************************************
*
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2011 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by trade secret or copyright law.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(function(a){a.Util.require("s7sdk.common.Geometry");a.Util.require("s7sdk.event.Event");if(!a.Tile){a.Tile=function(f,d,c,b,e){if(b==null){b="jpg"}if(e==null){e=0}this.invalidated=true;this.loaded=false;this.loadSent=false;this.level=f;this.tileAddress=d;this.url=c;this.fmt=b;this.transparent=((this.fmt.indexOf("png")!=-1||this.fmt.indexOf("gif")!=-1)&&(this.fmt.indexOf("-alpha")>0))?true:false;this.image=null;this.loadTile(e)};a.Tile.loadedTileStack=[];a.Tile.maxHighResTileImages=-1;a.Tile.timeout=function(b){b.load()};a.Tile.prototype.releaseImage=function(b){b.image=this.image;this.image=null};a.Tile.prototype.loadTile=function(b){if(b<0){return}a.Logger.log(a.Logger.FINEST,"Tile.loadTile %0, %1",this.tileAddress.pos_x,this.tileAddress.pos_y);if(b==0){this.load()}else{a.Util.timeout(a.Tile.timeout,b,[this])}this.loadSent=true};a.Tile.prototype.load=function(){var b=this.url+(this.url.indexOf("?")<0?"?":"&");b+="req=tile&rect="+this.tileAddress.pos_x*256+","+this.tileAddress.pos_y*256+",";b+=this.tileAddress.w+","+this.tileAddress.h;b+="&fmt="+this.fmt;if(a.Tile.maxHighResTileImages>0&&a.Tile.loadedTileStack.length>a.Tile.maxHighResTileImages){var c=a.Tile.loadedTileStack.shift();this.image=c.image;c.image=null;c.loaded=false;c.loadSent=false}else{this.image=new Image()}if(a.Tile.maxHighResTileImages>0&&this.level==0){a.Tile.loadedTileStack.push(this)}this.image.onload=this.onLoadImage;this.image.onerror=this.onErrorImage;this.image.onabort=this.onAbortImage;this.image.imageTile=this;this.image.src=b;a.Logger.log(a.Logger.FINER,"Tile.load %0",b)};a.Tile.prototype.onLoadImage=function(b){this.imageTile.loaded=true;this.imageTile.invalidated=true;a.Event.dispatch(this,a.Event.TILE_LOADED,true)};a.Tile.prototype.onErrorImage=function(b){a.Logger.log(a.Logger.WARNING,"Tile failed to load");a.Event.dispatch(this,a.Event.TILE_FAILED,true)};a.Tile.prototype.onAbortImage=function(b){a.Logger.log(a.Logger.WARNING,"Tile failed to load");a.Event.dispatch(this,a.Event.TILE_FAILED,true)};a.Tile.prototype.invalidate=function(){this.invalidated=true};a.Tile.prototype.addEventListener=function(d,c,b){a.Base.prototype.addEventListener.apply(this,[d,c,b])};a.Tile.prototype.draw=function(b,h,l){if(this.invalidated==false){return}var j=new a.Matrix2D(1,0,0,1,this.tileAddress.pos_x*a.Enum.TILE.SIZE,this.tileAddress.pos_y*a.Enum.TILE.SIZE);j.concat(b);var c=h.getContext("2d");if(this.loaded){this.invalidated=false;if(this.transparent){c.clearRect(j.tx,j.ty,this.tileAddress.w,this.tileAddress.h)}c.drawImage(this.image,0,0,this.tileAddress.w,this.tileAddress.h,j.tx,j.ty,this.tileAddress.w,this.tileAddress.h)}else{var d=256;var g=256;var f=0;var e=0;var i=l.lowerTile(this.level,this.tileAddress);if(i!=null){var m=i.image;var k=Math.pow(2,i.level-this.level);d=256/k;g=256/k;f=d*(this.tileAddress.x()%k);e=g*(this.tileAddress.y()%k);if(d+f>i.image.width){d=i.image.width-f}if(g+e>i.image.height){g=i.image.height-e}if(d>0&&g>0){if(this.transparent){c.clearRect(j.tx,j.ty,this.tileAddress.w,this.tileAddress.h)}c.drawImage(i.image,f,e,d,g,j.tx,j.ty,this.tileAddress.w,this.tileAddress.h);a.Logger.log(a.Logger.FINEST,"Tile.draw Rendering from lower tile: %0 %1 %2 %3 to %4 %5 %6 %7 ",f,e,d,g,j.tx,j.ty,this.tileAddress.w,this.tileAddress.h)}else{a.Logger.log(a.Logger.FINER,"Tile.draw empty source size: %0 %1 %2 %3 to %4 %5 %6 %7 ",f,e,d,g,j.tx,j.ty,this.tileAddress.w,this.tileAddress.h)}}else{a.Logger.log(a.Logger.FINER,"Tile.draw level "+this.level+" empty tile idx "+this.tileAddress.idx+" x "+this.tileAddress.pos_x+" y "+this.tileAddress.pos_y)}}}}})(s7getCurrentNameSpace());