/*!************************************************************************
*
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2011 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by trade secret or copyright law.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(function(a){a.pkg("s7sdk.rgn");a.Util.require("s7sdk.event.Event");a.Util.require("s7sdk.common.Enumeration");a.Util.require("s7sdk.image.rgn.Resolution");if(!a.rgn.View){a.VIEW_ALIGN_LEFT=1;a.VIEW_ALIGN_CENTER=0;a.VIEW_ALIGN_RIGHT=2;a.rgn.View=function(f,k,u,b,j,t,o,v,w,p,e,m,g,d,l,n,h,r){a.Logger.log(a.Logger.FINER,"View.ctor (no canvas) url: %0 image size: %1 x %2 view size: %3 x %4",f,k,u,b,j);this.idx=typeof(h)=="undefined"?0:h;this.aspect=k/u;this.imageWidth=k;this.imageHeight=u;this.zoomLimit=a.Util.checkDefault(l,0);this.h=j;this.w=b;if(this.w==0){this.w=Math.round(this.aspect*j)}this.align=typeof(r)=="undefined"?a.VIEW_ALIGN_CENTER:r;this.constrainWidth=(this.align==a.VIEW_ALIGN_CENTER)?1:0.5;this.url=f;this.textoverlay=null;this.state=7;this.maxHeight=Math.round(u*v);this.zoomStep=a.Util.checkDefault(o,1);this.limit=a.Util.checkDefault(v,1);this.transitionTime=a.Util.checkDefault(w,0.5)*1000;this.transitionEasing=a.Util.checkDefault(p,0);this.clickToZoom=a.Util.checkDefault(g,9);this.elasticZoom=a.Util.checkDefault(m,0);this.elasticZoom=(this.elasticZoom<0)?0:(this.elasticZoom>1)?1:this.elasticZoom;this.elasticZoom=(this.elasticZoom>0)?this.elasticZoom*0.3+0.69:0;this.fmt=a.Util.checkDefault(d,"jpg");this.transparent=((this.fmt.indexOf("png")!=-1||this.fmt.indexOf("gif")!=-1)&&(this.fmt.indexOf("-alpha")>0))?true:false;this.zoomLimit=a.Util.checkDefault(l,0);this.inPan=false;this.inPinch=false;this.sliding=false;this.speedX=0;this.speedY=0;this.lastTx=0;this.lastTy=0;this.inTransition=false;this.prevStep=0;this.maxStep=1;this.resized=false;this.tileRender=true;this.loadResetImage=a.Util.checkDefault(n,true);this.viewReady=false;this.onResetImageLoaded=a.Util.noop;this.devicePixelRatio=t;this.setInitView();this.targetViewToImage=this.resetView();this.topScale=1/this.maxHeight;this.initScale=this.targetViewToImage.d;if(!a.Util.isNull(e)){this.targetViewToImage=this.zoomViewTransform(e)}this.viewToImage=this.targetViewToImage.clone();this.checkState();this.resolutions=new Array();var s=Math.floor(Math.log(1/this.limit)/Math.log(2));var q=Math.round(k/Math.pow(2,s));var c=Math.round(u/Math.pow(2,s));var x;do{x=new a.rgn.Resolution(s++,q,c,f,this.fmt,this);this.resolutions.push(x);q=Math.round(q/2);c=Math.round(c/2)}while(q>256||c>256);this.resolutions.reverse();this.calcRes();this.displayElement=null;this.resetImageLoaded=false;this.resetImage=new Image();this.resetImage.onload=this.onLoadImage;this.resetImage.onerror=this.onErrorImage;this.resetImage.onabort=this.onAbortImage;this.resetImage.view=this;this.delayTileLoad=false;this.parentView=null;this.invalidated=false;this.drawInterval=a.Util.interval(a.rgn.View.intervalDraw,1000/12,[this])};a.rgn.View.epsilon1=0.01;a.rgn.View.epsilon2=0.00001;a.rgn.View.createDisplay=function(){var b=a.Util.createObj(null,"div",null,null);b.style.position="relative";b.style.overflow="hidden";return b};a.rgn.View.prototype.changeStatus=function(b){};a.rgn.View.prototype.writeOverlay=function(b){this.textoverlay=b};a.rgn.View.prototype.init=function(){var b=24;if(this.transitionTime>0){this.maxStep=2000/(b*transitionTime)}};a.rgn.View.prototype.findParentElement=function(){return this.parentView.obj};a.rgn.View.prototype.getDisplayElement=function(){return this.displayElement};a.rgn.View.prototype.attach=function(b){this.parentView=b;this.displayElement=b.displayElement;this.displayElement.view=this;this.loadImage();this.invalidate()};a.rgn.View.prototype.detach=function(){if(null!=this.displayElement){this.displayElement.view=null;this.displayElement=null}};a.rgn.View.prototype.loadImage=function(){if(this.resetImageLoaded||this.resetImage.src){return}var b=this.url+(this.url.indexOf("?")>=0?"&":"?")+"wid="+Math.floor(this.width)+"&hei="+Math.floor(this.height)+"&fmt="+this.fmt;a.Logger.log(a.Logger.INFO,"View.loadImage %0",b);this.resetImage.src=b};a.rgn.View.prototype.onLoadImage=function(d){var d=d||window.event;var c=a.Event.getTarget(d)||this;if(c.view.viewParent!=null&&c.view.viewParent.onReadyToDislpay){c.view.viewParent.onReadyToDislpay()}c.view.invalidate(true);c.view.resetImageLoaded=true;if(c.view.resized){if(c.width==c.view.width&&c.height==c.view.height){c.view.resized=false}}c.view.onResetImageLoaded.apply(c.view,[true,c.view.idx]);if(c.view.viewParent&&c.view.viewParent.sendStatusEvent){c.view.viewReady=true;c.view.viewParent.sendStatusEvent(c.view)}else{var b=new a.event.StatusEvent(a.event.StatusEvent.NOTF_VIEW_READY,true);a.Event.dispatch(c.view.findParentElement(),b,false);if(!c.view.viewReady){var b=new a.event.StatusEvent(a.event.StatusEvent.NOTF_HIGHRES_VIEW_READY,true);a.Event.dispatch(c.view.findParentElement(),b,false)}c.view.viewReady=true}};a.rgn.View.prototype.onErrorImage=function(c){var c=c||window.event;var b=a.Event.getTarget(c)||this;b.view.onResetImageLoaded.apply(b.view,[false,b.view.idx]);a.Logger.log(a.Logger.WARNING,"Reset image failed to load")};a.rgn.View.prototype.onAbortImage=function(c){var c=c||window.event;var b=a.Event.getTarget(c)||this;b.view.onResetImageLoaded.apply(b.view,[false,b.view.idx]);a.Logger.log(a.Logger.WARNING,"Reset image did not finish loading")};a.rgn.View.prototype.clampScale=function(b,d,c){if(b.d*d>this.initScale){d=this.initScale/b.d}else{if(b.d*d<this.topScale){d=this.topScale/b.d}}if(c&&this.zoomLimit>0&&b.d*d<this.initScale/this.zoomLimit){d=this.initScale/(this.zoomLimit*b.d)}if(Math.abs(d-1)<a.rgn.View.epsilon2){return 1}else{return d}};a.rgn.View.prototype.scaleView=function(b){if(this.elasticZoom==0){b=this.clampScale(this.viewToImage,b);if(b==1){return}this.scaleTransform(this.viewToImage,b);this.clampToImage(this.viewToImage);this.calcRes();this.invalidate(true);this.checkState()}else{if(!this.inTransition){this.targetViewToImage=this.viewToImage.clone()}b=this.clampScale(this.targetViewToImage,b);if(b==1){return}this.scaleTransform(this.targetViewToImage,b);this.clampToImage(this.targetViewToImage);this.startTransition()}};a.rgn.View.prototype.scaleTransform=function(d,e){var f=d.transformPoint(new a.Point2D(this.w/2,this.h/2));d.scale(e,e);var c=d.a*this.w/2+d.b*this.h/2;var b=d.c*this.w/2+d.d*this.h/2;d.tx=f.x-c;d.ty=f.y-b};a.rgn.View.prototype.resize=function(e,f){this.stopAction();if(this.displayElement!=null){this.displayElement.width=e;this.displayElement.height=f}var g=this.width;var c=this.height;var j=this.viewToImage.transformPoint(new a.Point2D(this.w/2,this.h/2));this.w=e;this.h=f;this.setInitView();this.initScale=1/this.height;var i=this.clampScale(this.viewToImage,c/this.height);this.viewToImage.translate(this.viewToImage.tx*-1,this.viewToImage.ty*-1);this.viewToImage.scale(i,i);var d=this.viewToImage.a*this.w/2+this.viewToImage.b*this.h/2;var b=this.viewToImage.c*this.w/2+this.viewToImage.d*this.h/2;this.viewToImage.tx=j.x-d;this.viewToImage.ty=j.y-b;this.clampToImage(this.viewToImage);this.calcRes();this.resized=true;this.resized=true;if(this.resetImageLoaded){if(this.width==this.resetImage.width&&this.height==this.resetImage.height){this.resized=false}}this.invalidate(false);if(this.viewParent!=null&&this.viewParent.viewInvalidate){this.viewParent.viewInvalidate(this.getViewPort())}this.checkState()};a.rgn.View.prototype.checkState=function(){var b=0;if(Math.abs(this.viewToImage.d-this.initScale)>a.rgn.View.epsilon2){b=6}if(Math.abs(this.viewToImage.d-this.topScale)>a.rgn.View.epsilon2){b|=8;if(this.zoomLimit>0&&this.viewToImage.d>this.initScale/this.zoomLimit&&this.viewToImage.d-this.initScale/this.zoomLimit>a.rgn.View.epsilon2){b|=1}else{if(this.zoomLimit<=0){b|=1}}}if(b&4){var c=this.getViewPort();if(c.x>a.rgn.View.epsilon2){b|=16}if(Math.abs(1-(c.x+c.width))>a.rgn.View.epsilon2){b|=32}if(c.y>a.rgn.View.epsilon2){b|=64}if(Math.abs(1-(c.y+c.height))>a.rgn.View.epsilon2){b|=128}}if(b==this.state){return}this.state=b;if(this.viewParent!=null){this.viewParent.viewStateChange.apply(this.viewParent,[b])}};a.rgn.View.prototype.pinchZoom=function(h,f,b,i){a.Logger.log(a.Logger.FINER,"pinchZoom x %0 y %1 scaleInc %2",h,f,b);h*=this.devicePixelRatio;f*=this.devicePixelRatio;var j=this.clampScale(i,b,false);if(j==1){return}var g=this.viewToImage.transformPoint(new a.Point2D(h,f));this.viewToImage=i.clone();var d=this.viewToImage.tx;var c=this.viewToImage.ty;this.viewToImage.translate(-d,-c);this.viewToImage.scale(j,j);var e=this.viewToImage.transformPoint(new a.Point2D(h,f));this.viewToImage.tx=g.x-e.x;this.viewToImage.ty=g.y-e.y;this.clampToImage(this.viewToImage);this.calcRes();this.invalidate(true);this.checkState()};a.rgn.View.prototype.zoomClick=function(c,h,e){c*=this.devicePixelRatio;h*=this.devicePixelRatio;a.Logger.log(a.Logger.FINER,"zoomClick(%0, %1, %2)",c,h,e);var f;if(e){f=this.zoomScale}else{f=1/this.zoomScale}f=this.clampScale(this.viewToImage,f,true);if(f==1){return}this.targetViewToImage=this.viewToImage.clone();var g=this.targetViewToImage.transformPoint(new a.Point2D(c,h));this.targetViewToImage.scale(f,f);var d=this.targetViewToImage.a*this.w/2+this.targetViewToImage.b*this.h/2;var b=this.targetViewToImage.c*this.w/2+this.targetViewToImage.d*this.h/2;this.targetViewToImage.tx=g.x-d;this.targetViewToImage.ty=g.y-b;this.clampToImage(this.targetViewToImage);this.startTransition()};a.rgn.View.prototype.doNPan=function(c,b,d){this.viewToImage.tx-=c;this.viewToImage.ty-=b;this.clampToImage(this.viewToImage);this.checkState();this.invalidate(d)};a.rgn.View.prototype.doPan=function(c,b,d){this.viewToImage.tx=this.viewToImage.tx-c*this.viewToImage.a*this.devicePixelRatio;this.viewToImage.ty=this.viewToImage.ty-b*this.viewToImage.d*this.devicePixelRatio;this.clampToImage(this.viewToImage);this.checkState();this.invalidate(d)};a.rgn.View.prototype.draw=function(){if(!this.invalidated){return}if(this.displayElement==null){return}var k=this.viewToImage.clone();k.invert();var c=k.transformPoint(new a.Point2D(0,0));var b=k.transformPoint(new a.Point2D(1,1));var d=new a.Rectangle(c.x,c.y,b.x-c.x,b.y-c.y);var f=new a.Rectangle(0,0,this.w,this.h);d=d.intersection(f);if(this.res.loaded()&&(!this.inTransition&&!this.inPan&&!this.inPinch&&(this.tileRender&&(this.resized||Math.abs(this.viewToImage.d-this.initScale)>a.rgn.View.epsilon2)))){var l=this.viewToRes();var g=this.res.getResToRgn();var h=l;h.concat(g);var i=h;i.invert();var j=this.res.getRegionImage();if(j&&j.imageRegion.loaded){this.drawImage(j,i)}}else{if(!this.resetImageLoaded){return}var e=this.viewToImage.clone();e.scale(this.resetImage.width,this.resetImage.height);e.invert();a.Util.setObjSize(this.resetImage,Math.round(this.resetImage.width*e.a),Math.round(this.resetImage.height*e.d));a.Util.setObjPos(this.resetImage,Math.round(e.tx),Math.round(e.ty));if(this.displayElement.firstChild){this.displayElement.replaceChild(this.resetImage,this.displayElement.firstChild)}else{this.displayElement.appendChild(this.resetImage)}}this.invalidated=false;if(typeof(this.parentView.drawChild)!="undefined"){this.parentView.drawChild()}this.displayElement.firstChild.style.filter="inherit"};a.rgn.View.prototype.drawImage=function(c,b){c.width=Math.round(c.startWidth*b.a);c.height=Math.round(c.startHeight*b.d);a.Util.setObjPos(c,Math.round(b.tx),Math.round(b.ty));if(this.displayElement.firstChild){if(this.displayElement.firstChild!=c){this.displayElement.replaceChild(c,this.displayElement.firstChild)}}else{this.displayElement.appendChild(c)}};a.rgn.View.prototype.resetView=function(){var e=1/this.height;var d=new a.Matrix2D(e/this.aspect,0,0,e,0,0);var c=d.a*this.w/2+d.b*this.h/2;var b=d.c*this.w/2+d.d*this.h/2;if(this.align==a.VIEW_ALIGN_LEFT){d.tx=1-c}else{if(this.align==a.VIEW_ALIGN_RIGHT){d.tx=0-c}else{d.tx=0.5-c}}d.ty=0.5-b;return d};a.rgn.View.prototype.setInitView=function(){var b=(this.constrainWidth<1)?this.w*this.constrainWidth:this.w;if(b/this.h>this.aspect){this.width=Math.round(this.aspect*this.h);this.height=this.h}else{this.width=b;this.height=Math.round(b/this.aspect)}if(this.maxHeight<this.height){this.height=this.maxHeight;this.width=Math.round(this.aspect*this.height)}var c=(this.zoomStep>0)?this.zoomStep:Math.log(2)/Math.log(this.maxHeight/this.h);this.zoomScale=Math.pow(2,1/c);if(this.elasticZoom<=0){this.scaleInc=Math.pow(2,1/(c*10))}else{this.scaleInc=Math.pow(2,1/(c))}};a.rgn.View.prototype.startTransition=function(){this.startViewToImage=this.viewToImage.clone();var b=new Date();this.startTime=b.getTime();this.prevStep=0;if(!this.inTransition){a.Util.timeout(a.rgn.View.transitionHandler,25,[this])}this.inTransition=true;if(this.viewParent!=null&&this.viewParent.viewTransitionStart!=null){this.viewParent.viewTransitionStart()}};a.rgn.View.transitionHandler=function(b){var c=false;c=b.onEnterFrame();if(c){a.Util.timeout(a.rgn.View.transitionHandler,25,[b])}};a.rgn.View.prototype.stopTransition=function(){if(this.inTransition){this.viewToImage=this.targetViewToImage.clone();this.inTransition=false;this.checkState();if(this.viewParent!=null&&this.viewParent.viewTransitionStop!=null){this.viewParent.viewTransitionStop()}}};a.rgn.View.prototype.stopAction=function(){this.stopTransition()};a.rgn.View.prototype.onEnterFrame=function(){var b=new Date();var c=b.getTime();var k=(this.transitionTime!=0)?(c-this.startTime)/this.transitionTime:1;if(k>this.prevStep+this.maxStep){k=this.prevStep+this.maxStep}this.prevStep=k;if(k==0){return true}if(k>=1){this.viewToImage=this.targetViewToImage.clone();this.calcRes();this.invalidate(false);this.stopTransition();return false}if(this.transitionEasing==a.Enum.TRANSITION_EASING.AUTO){if(this.elasticZoom>0){if(this.transitionTime>=1500){k=(k*(k-2))*-1}else{if(this.transitionTime>1000){k=(k-=1)*k*k+1}else{if(this.transitionTime>500){k=((k-=1)*k*k*k-1)*-1}else{k=(k-=1)*k*k*k*k+1}}}}}else{if(this.transitionEasing==a.Enum.TRANSITION_EASING.QUADRATIC){k=(k*(k-2))*-1}else{if(this.transitionEasing==a.Enum.TRANSITION_EASING.CUBIC){k=(k-=1)*k*k+1}else{if(this.transitionEasing==a.Enum.TRANSITION_EASING.QUARTIC){k=((k-=1)*k*k*k-1)*-1}else{if(this.transitionEasing==a.Enum.TRANSITION_EASING.QUINTIC){k=(k-=1)*k*k*k*k+1}}}}}var j=1/k;var d=Math.exp(Math.log(this.targetViewToImage.d/this.startViewToImage.d)/j);var i;if(Math.abs(1-d)>1e-12){i=(1-Math.pow(d,j))/(1-d)}else{i=j}var h=(this.targetViewToImage.tx-this.startViewToImage.tx)/i;var g=(this.targetViewToImage.ty-this.startViewToImage.ty)/i;this.viewToImage=this.startViewToImage.clone();var f=this.viewToImage.tx;var e=this.viewToImage.ty;this.viewToImage.translate(-f,-e);this.viewToImage.scale(d,d);this.viewToImage.translate(f+h,e+g);this.calcRes();if((1-k)<0.1){this.invalidate(false)}else{this.invalidate(true)}this.checkState();return true};a.rgn.View.prototype.calcRes=function(){var c;var b=this.resolutions.length-1;if(this.viewToImage.a>this.viewToImage.d){c=this.viewToImage.a*this.resolutions[b].w}else{c=this.viewToImage.d*this.resolutions[b].h}while(c+a.rgn.View.epsilon1>2&&b>0){b--;c/=2}this.res=this.resolutions[b]};a.rgn.View.prototype.invalidate=function(c){c=!!c;if(c==false&&this.tileRender&&this.resized==false&&Math.abs(this.viewToImage.d-this.initScale)<a.rgn.View.epsilon2){c=true}var d=new a.Rectangle(0,0,this.w,this.h);var b=this.viewToRes();d.x=Math.round(b.a*d.x+b.b*d.y+b.tx);d.y=Math.round(b.c*d.x+b.d*d.y+b.ty);d.width=Math.round(b.a*d.width+b.b*d.height);d.height=Math.round(b.c*d.width+b.d*d.height);if(!c){this.res.intersect(d)}this.invalidated=true;if(this.viewParent!=null){this.viewParent.viewInvalidate(this.getViewPort())}};a.rgn.View.intervalDraw=function(b){b.draw()};a.rgn.View.prototype.unload=function(b){if(b&8){if(this.drawInterval){clearInterval(this.drawInterval);this.drawInterval=null}}if(this.resolutions==null){return}if(b&1){for(var c=0;c<this.resolutions.length;c++){this.resolutions[c].release()}}};a.rgn.View.prototype.clampToImage=function(d){var f=this.h*d.d;var e=this.w*d.a;if(f<=1){d.ty=Math.max(d.ty,0);d.ty=Math.min(d.ty,1-f)}else{var b=d.d*this.h/2;d.ty=0.5-b}if(e<=1){d.tx=Math.max(d.tx,0);d.tx=Math.min(d.tx,1-e)}else{var c=d.a*this.w/2;if(this.align==a.VIEW_ALIGN_LEFT){d.tx=1-c;d.tx=Math.min(d.tx,0)}else{if(this.align==a.VIEW_ALIGN_RIGHT){d.tx=0-c;d.tx=Math.max(d.tx,1-e)}else{d.tx=0.5-c}}}};a.rgn.View.prototype.zoomViewTransform=function(j){var g=j.width*this.aspect;var c=j.height;var f;var k;var i=this.w;if((Math.abs(j.x-0)<a.rgn.View.epsilon2)&&(Math.abs(j.y-0)<a.rgn.View.epsilon2)&&(Math.abs(j.right-1)<a.rgn.View.epsilon2)&&(Math.abs(j.bottom-1)<a.rgn.View.epsilon2)){i=this.constrainWidth*i}if(i/this.h>g/c){k=j.height/this.h;f=k/this.aspect}else{f=j.width/i;k=f*this.aspect}var h=new a.Matrix2D(f,0,0,k,j.x,j.y);if(h.d<this.topScale){var b=this.topScale/h.d;var e=h.tx;var d=h.ty;h.translate(-e,-d);h.scale(b,b);h.translate(e,d)}this.clampToImage(h);return h};a.rgn.View.prototype.viewToRes=function(){var b=this.viewToImage.clone();b.scale(this.res.w,this.res.h);return b};a.rgn.View.prototype.getViewPort=function(){var b=new a.Rectangle(0,0,this.w,this.h);b.x=this.viewToImage.a*b.x+this.viewToImage.b*b.y+this.viewToImage.tx;b.y=this.viewToImage.c*b.x+this.viewToImage.d*b.y+this.viewToImage.ty;b.width=this.viewToImage.a*b.width+this.viewToImage.b*b.height;b.height=this.viewToImage.c*b.width+this.viewToImage.d*b.height;return b.intersection(new a.Rectangle(0,0,1,1))};a.rgn.View.prototype.imagePixelsToViewPoint=function(b){var c=this.viewToImage.clone();c.scale(this.imageWidth,this.imageHeight);c.invert();return c.transformPoint(b)};a.rgn.View.prototype.viewPointToImagePixels=function(b){var c=this.viewToImage.clone();c.scale(this.imageWidth,this.imageHeight);return c.transformPoint(b)};a.rgn.View.prototype.zoomIn=function(){this.zoomClick(this.w/2,this.h/2,false)};a.rgn.View.prototype.zoomOut=function(){this.zoomClick(this.w/2,this.h/2,true)};a.rgn.View.prototype.zoomReset=function(){this.targetViewToImage=this.resetView();this.startTransition()};a.rgn.View.prototype.zoomNRgn=function(b){this.targetViewToImage=this.zoomViewTransform(b);this.startTransition()};a.rgn.View.prototype.zoomRgn=function(b){this.zoomNRgn(new a.Rectangle(b.x/this.imageWidth,b.y/this.imageHeight,b.width/this.imageWidth,b.height/this.imageHeight))};a.rgn.View.prototype.intervalDraw=function(b){b.draw();requestAnimFrame(function(){b.intervalDraw(b)})}}})(s7getCurrentNameSpace());