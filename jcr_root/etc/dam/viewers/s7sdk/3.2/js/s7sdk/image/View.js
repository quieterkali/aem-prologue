/*!************************************************************************
*
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2011 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by trade secret or copyright law.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(function(a){a.Util.require("s7sdk.event.Event");a.Util.require("s7sdk.common.Enumeration");a.Util.require("s7sdk.image.Resolution");a.Util.require("s7sdk.image.Tile");if(!a.View){a.VIEW_ALIGN_LEFT=1;a.VIEW_ALIGN_CENTER=0;a.VIEW_ALIGN_RIGHT=2;a.View=function(f,k,u,b,j,t,o,v,y,p,e,m,g,d,l,n,h,r){a.Logger.log(a.Logger.FINER,"s7sdk.View constructor (canvas based) - url: %0, image size: %1 x %2, view size: %3 x %4",f,k,u,b,j);this.idx=typeof(h)=="undefined"?0:h;this.aspect=k/u;this.imageWidth=k;this.imageHeight=u;this.zoomLimit=a.Util.checkDefault(l,0);this.h=j;this.w=b;if(this.w==0){this.w=Math.round(this.aspect*j)}this.align=typeof(r)=="undefined"?a.VIEW_ALIGN_CENTER:r;this.constrainWidth=(this.align==a.VIEW_ALIGN_CENTER)?1:0.5;this.url=f;this.textoverlay=null;this.state=7;this.maxHeight=Math.round(u*v);this.zoomStep=a.Util.checkDefault(o,1);this.limit=a.Util.checkDefault(v,1);this.transitionTime=a.Util.checkDefault(y,0.5)*1000;this.transitionEasing=a.Util.checkDefault(p,0);this.clickToZoom=a.Util.checkDefault(g,9);this.elasticZoom=a.Util.checkDefault(m,0);this.elasticZoom=(this.elasticZoom<0)?0:(this.elasticZoom>1)?1:this.elasticZoom;this.elasticZoom=(this.elasticZoom>0)?this.elasticZoom*0.3+0.69:0;this.fmt=a.Util.checkDefault(d,"jpg");this.transparent=((this.fmt.indexOf("png")!=-1||this.fmt.indexOf("gif")!=-1)&&(this.fmt.indexOf("-alpha")>0))?true:false;this.zoomLimit=a.Util.checkDefault(l,0);this.inPan=false;this.inPinch=false;this.sliding=false;this.speedX=0;this.speedY=0;this.lastTx=0;this.lastTy=0;this.inTransition=false;this.prevStep=0;this.maxStep=1;this.resized=false;this.tileRender=true;this.loadResetImage=a.Util.checkDefault(n,true);this.viewReady=false;this.devicePixelRatio=t;this.setInitView();this.targetViewToImage=this.resetView();this.topScale=1/this.maxHeight;this.initScale=this.targetViewToImage.d;if(!a.Util.isNull(e)){this.targetViewToImage=this.zoomViewTransform(e)}this.viewToImage=this.targetViewToImage.clone();this.checkState();this.resolutions=new Array();var s=Math.floor(Math.log(1/this.limit)/Math.log(2));var q=Math.round(k/Math.pow(2,s));var c=Math.round(u/Math.pow(2,s));var z;do{z=new a.Resolution(s++,q,c,f,this.fmt,this);this.resolutions.push(z);q=Math.round(q/2);c=Math.round(c/2)}while(z.nTiles()>1);a.View.maxLevel=s-1;this.resolutions.reverse();this.calcRes();var w=new a.TileAddress(this.resolutions[0].w,this.resolutions[0].h,0,0,0);var x=this.resolutions[0].getCreateTile(w,0);if(x.image!=null&&x.image.addEventListener!=null){x.image.parentView=this;x.image.addEventListener(a.Event.TILE_LOADED,this.onTileLoad,true);x.image.addEventListener(a.Event.TILE_FAILED,this.onTileLoad,true)}this.canvas=null;this.resetImageLoaded=false;this.resetImage=new Image();this.resetImage.onload=this.onLoadImage;this.resetImage.onerror=this.onErrorImage;this.resetImage.onabort=this.onAbortImage;this.resetImage.view=this;this.onResetImageLoaded=a.Util.noop;this.delayTileLoad=false;this.parentView=null;this.invalidated=false;this.drawInterval=a.Util.interval(a.View.intervalDraw,60,[this])};a.View.epsilon1=0.01;a.View.epsilon2=0.00001;a.View.epsilon3=1e-9;a.View.createDisplay=function(){return a.Util.createObj(null,"canvas",null,null)};a.View.prototype.changeStatus=function(b){};a.View.prototype.writeOverlay=function(b){this.textoverlay=b};a.View.prototype.init=function(){var b=24;if(this.transitionTime>0){this.maxStep=2000/(b*transitionTime)}};a.View.prototype.findParentElement=function(){return this.parentView.obj};a.View.prototype.getDisplayElement=function(){return this.canvas};a.View.prototype.attach=function(c){this.parentView=c;this.canvas=c.displayElement;var b=this.findParentElement();this.canvas.view=this;this.invalidate()};a.View.prototype.detach=function(){if(null!=this.canvas){this.canvas.view=null;this.canvas=null}this.parentView=null};a.View.prototype.onTileLoad=function(c){var b=a.Event.getTarget(c);if(b.parentView.isLowerTileLoaded()&&!b.parentView.viewReady){if(!b.parentView.viewParent){b.removeEventListener(a.Event.TILE_LOADED,this.onTileLoad,true);b.removeEventListener(a.Event.TILE_FAILED,this.onTileLoad,true);b.parentView=null;return}b.parentView.onTileLoadArise=true}b.removeEventListener(a.Event.TILE_LOADED,this.onTileLoad,true);b.removeEventListener(a.Event.TILE_FAILED,this.onTileLoad,true);if(b.parentView.viewParent!=null&&b.parentView.viewParent.onReadyToDislpay){b.parentView.viewParent.onReadyToDislpay()}b.parentView.invalidate(true);if(b.parentView.loadResetImage){b.parentView.loadImage()}b.parentView=null};a.View.prototype.loadImage=function(){if(this.resetImageLoaded||this.resetImage.src){return}var b=this.url+(this.url.indexOf("?")>=0?"&":"?")+"wid="+Math.floor(this.width)+"&hei="+Math.floor(this.height)+"&fmt="+this.fmt;a.Logger.log(a.Logger.INFO,"s7sdk.View.loadImage - requestUrl: %0",b);this.resetImage.src=b};a.View.prototype.onLoadImage=function(c){var c=c||window.event;var b=a.Event.getTarget(c);b.view.invalidate(true);b.view.resetImageLoaded=true;if(b.view.resized){if(b.width==b.view.width&&b.height==b.view.height){b.view.resized=false}}b.view.onResetImageLoaded.apply(b.view,[true,b.view.idx]);b.view.onLoadImageArise=true};a.View.prototype.onErrorImage=function(c){var b=a.Event.getTarget(c);b.view.onResetImageLoaded.apply(b.view,[false,b.view.idx]);a.Logger.log(a.Logger.WARNING,"s7sdk.View.onErrorImage - Reset image failed to load")};a.View.prototype.onAbortImage=function(c){var b=a.Event.getTarget(c);b.view.onResetImageLoaded.apply(b.view,[false,b.view.idx]);a.Logger.log(a.Logger.WARNING,"s7sdk.View.onAbortImage - Reset image did not finish the load")};a.View.prototype.lowerTile=function(i,f){var c=null;var h=i+1;var g;while((c==null||!c.loaded)&&h<=this.resolutions[0].level){var b=this.resolutions[0].level-h;var e=this.resolutions[b];var d=Math.floor(f.x()/Math.pow(2,h-i))+Math.floor(f.y()/Math.pow(2,h-i))*Math.ceil(e.w/a.Enum.TILE.SIZE);c=e.getTile(d);h++}return c};a.View.prototype.isLowerTileLoaded=function(){var b=this.resolutions[0].getTile(0);return((b!=null)&&(b.loaded))};a.View.prototype.clampScale=function(b,d,c){if(b.d*d>this.initScale){d=this.initScale/b.d}if(b.d*d<this.topScale){d=this.topScale/b.d}if(c&&this.zoomLimit>0&&b.d*d<this.initScale/this.zoomLimit){d=this.initScale/(this.zoomLimit*b.d)}if(Math.abs(d-1)<a.View.epsilon2){return 1}else{return d}};a.View.prototype.scaleView=function(b){if(this.elasticZoom==0){b=this.clampScale(this.viewToImage,b);if(b==1){return}this.scaleTransform(this.viewToImage,b);this.clampToImage(this.viewToImage);this.calcRes();this.invalidate(true);this.checkState()}else{if(!this.inTransition){this.targetViewToImage=this.viewToImage.clone()}b=this.clampScale(this.targetViewToImage,b);if(b==1){return}this.scaleTransform(this.targetViewToImage,b);this.clampToImage(this.targetViewToImage);this.startTransition()}};a.View.prototype.scaleTransform=function(d,e){var f=d.transformPoint(new a.Point2D(this.w/2,this.h/2));d.scale(e,e);var c=d.a*this.w/2+d.b*this.h/2;var b=d.c*this.w/2+d.d*this.h/2;d.tx=f.x-c;d.ty=f.y-b};a.View.prototype.resize=function(e,f){this.stopAction();if(this.canvas!=null){this.canvas.width=e;this.canvas.height=f}var g=this.width;var c=this.height;var j=this.viewToImage.transformPoint(new a.Point2D(this.w/2,this.h/2));this.w=e;this.h=f;this.setInitView();this.initScale=1/this.height;var i=this.clampScale(this.viewToImage,c/this.height);this.viewToImage.translate(this.viewToImage.tx*-1,this.viewToImage.ty*-1);this.viewToImage.scale(i,i);var d=this.viewToImage.a*this.w/2+this.viewToImage.b*this.h/2;var b=this.viewToImage.c*this.w/2+this.viewToImage.d*this.h/2;this.viewToImage.tx=j.x-d;this.viewToImage.ty=j.y-b;this.clampToImage(this.viewToImage);this.calcRes();this.resized=true;this.resized=true;if(this.resetImageLoaded){if(this.width==this.resetImage.width&&this.height==this.resetImage.height){this.resized=false}}this.invalidate(false);if(this.viewParent!=null&&this.viewParent.viewInvalidate){this.viewParent.viewInvalidate(this.getViewPort())}this.checkState()};a.View.prototype.checkState=function(){var b=0;if(Math.abs(this.viewToImage.d-this.initScale)>a.View.epsilon2){b=6}if(Math.abs(this.viewToImage.d-this.topScale)>a.View.epsilon2){b|=8;if(this.zoomLimit>0&&this.viewToImage.d>this.initScale/this.zoomLimit&&this.viewToImage.d-this.initScale/this.zoomLimit>a.View.epsilon2){b|=1}else{if(this.zoomLimit<=0){b|=1}}}if(b&4){var c=this.getViewPort();if(c.x>a.View.epsilon2){b|=16}if(Math.abs(1-(c.x+c.width))>a.View.epsilon2){b|=32}if(c.y>a.View.epsilon2){b|=64}if(Math.abs(1-(c.y+c.height))>a.View.epsilon2){b|=128}}if(b==this.state){return}this.state=b;if(this.viewParent!=null){this.viewParent.viewStateChange.apply(this.viewParent,[b])}};a.View.prototype.pinchZoom=function(h,f,b,i){a.Logger.log(a.Logger.FINEST,"s7sdk.View.pinchZoom - x: %0, y: %1, scale: %2",h,f,b);h*=this.devicePixelRatio;f*=this.devicePixelRatio;var j=this.clampScale(i,b,false);if(j==1){return}var g=this.viewToImage.transformPoint(new a.Point2D(h,f));this.viewToImage=i.clone();var d=this.viewToImage.tx;var c=this.viewToImage.ty;this.viewToImage.translate(-d,-c);this.viewToImage.scale(j,j);var e=this.viewToImage.transformPoint(new a.Point2D(h,f));this.viewToImage.tx=g.x-e.x;this.viewToImage.ty=g.y-e.y;this.clampToImage(this.viewToImage);this.calcRes();this.invalidate(true);this.checkState()};a.View.prototype.zoomClick=function(c,h,e){c*=this.devicePixelRatio;h*=this.devicePixelRatio;a.Logger.log(a.Logger.FINEST,"s7sdk.View.zoomClick - x: %0, y: %1, ctrlDown: %2",c,h,e);var f;if(e){f=this.zoomScale}else{f=1/this.zoomScale}f=this.clampScale(this.viewToImage,f,true);if(f==1){return}this.targetViewToImage=this.viewToImage.clone();var g=this.targetViewToImage.transformPoint(new a.Point2D(c,h));this.targetViewToImage.scale(f,f);var d=this.targetViewToImage.a*this.w/2+this.targetViewToImage.b*this.h/2;var b=this.targetViewToImage.c*this.w/2+this.targetViewToImage.d*this.h/2;this.targetViewToImage.tx=g.x-d;this.targetViewToImage.ty=g.y-b;this.clampToImage(this.targetViewToImage);this.startTransition()};a.View.prototype.doNPan=function(c,b,d){this.viewToImage.tx-=c;this.viewToImage.ty-=b;this.clampToImage(this.viewToImage);this.checkState();this.invalidate(d)};a.View.prototype.doPan=function(c,b,d){this.viewToImage.tx=this.viewToImage.tx-c*this.viewToImage.a*this.devicePixelRatio;this.viewToImage.ty=this.viewToImage.ty-b*this.viewToImage.d*this.devicePixelRatio;this.clampToImage(this.viewToImage);this.checkState();this.invalidate(d)};a.View.prototype.draw=function(){if(!this.invalidated){return}if(this.canvas==null){return}var o=this.canvas.getContext("2d");if(o==null){return}var n=this.viewToImage.clone();n.invert();var d=n.transformPoint(new a.Point2D(0,0));var c=n.transformPoint(new a.Point2D(1,1));var g=new a.Rectangle(d.x,d.y,c.x-d.x,c.y-d.y);var i=new a.Rectangle(0,0,this.w,this.h);g=g.intersection(i);var e=new a.Rectangle(Math.round(g.x),Math.round(g.y),Math.round(g.width),Math.round(g.height));if(g.containsRect(i)==false){if(e.y>0){o.clearRect(0,0,this.canvas.width,e.y+1)}if(e.height+e.y<this.canvas.height){o.clearRect(0,e.height+e.y-1,this.canvas.width,this.canvas.height-e.height+e.y+1)}if(e.x>0){o.clearRect(0,0,e.x+1,this.canvas.height)}if(e.width+e.x<this.canvas.width){o.clearRect(e.x+e.width-1,0,this.canvas.width-e.x+e.width+1,this.canvas.height)}}if(!this.resetImageLoaded||(!this.inTransition&&!this.inPan&&!this.inPinch&&(this.tileRender&&(this.resized||Math.abs(this.viewToImage.d-this.initScale)>a.View.epsilon2)))){if(!this.isLowerTileLoaded()){return}var j=this.viewToRes();j.invert();this.cleanUpCanvasAndroid4();this.res.draw(g,j,this);a.Logger.log(a.Logger.FINEST,"s7sdk.View.draw - Rendering from tiles: %0",g.toString())}else{var h=this.viewToImage.clone();h.scale(this.resetImage.width,this.resetImage.height);var f=h.transformRect(g);var l=new a.Rectangle(0,0,this.resetImage.width,this.resetImage.height);var m=f.intersection(l);var k=Math.abs(this.viewToImage.d-this.initScale)>a.View.epsilon3;a.Logger.log(a.Logger.FINEST,"s7sdk.View.draw - Rendering from image: %0 to: %1",m.toString(),g.toString());a.Logger.log(a.Logger.FINEST,"s7sdk.View - inPan: %0, inPinch: %1, resetImageLoaded: %2, inTransition: %3, tileRender: %4, resized: %5",this.inPan,this.inPinch,this.resetImageLoaded,this.inTransition,this.tileRender,this.resized);if(!isNaN(m.x)&&!isNaN(m.y)&&m.height>0&&m.width>0){if(this.transparent){if(g.x==0&&g.y==0&&g.width==this.canvas.width&&g.height==this.canvas.height){this.canvas.width=g.width}else{o.clearRect(g.x,g.y,g.width,g.height)}}this.cleanUpCanvasAndroid4();if(k||this.resized){o.drawImage(this.resetImage,m.x,m.y,m.width,m.height,g.x,g.y,g.width,g.height)}else{o.drawImage(this.resetImage,0,0,this.resetImage.width,this.resetImage.height,Math.round(g.x),Math.round(g.y),this.resetImage.width,this.resetImage.height)}}}if(this.textoverlay!=null){o.font="30px Times New Roman";o.fillStyle="Black";o.fillText(this.textoverlay,this.canvas.width/2-50,this.canvas.height/2-15)}this.invalidated=false;if(typeof(this.parentView.drawChild)!="undefined"){this.parentView.drawChild()}if(this.onTileLoadArise){if(this.viewParent.sendStatusEvent){this.viewParent.sendStatusEvent(this)}else{var b=new a.event.StatusEvent(a.event.StatusEvent.NOTF_VIEW_READY,true);a.Event.dispatch(this.viewParent,b,false);this.viewReady=true}this.onTileLoadArise=false}if(this.onLoadImageArise){if(this.viewParent&&this.viewParent.sendStatusEvent){this.viewParent.sendStatusEvent(this)}else{if(!this.viewParent){return}if(this.viewReady){var b=new a.event.StatusEvent(a.event.StatusEvent.NOTF_HIGHRES_VIEW_READY,true);a.Event.dispatch(this.viewParent,b,false)}if(!this.viewReady){var b=new a.event.StatusEvent(a.event.StatusEvent.NOTF_VIEW_READY,true);a.Event.dispatch(this.viewParent,b,false);this.viewReady=true}}this.onLoadImageArise=false}};a.View.prototype.cleanUpCanvasAndroid4=function(){if(a.browser.device.name=="android"&&a.browser.device.version=="4"&&!(a.browser.name=="chrome")){this.canvas.style.visibility="hidden";var b=this.canvas.offsetHeight;this.canvas.style.visibility=""}};a.View.prototype.resetView=function(){var e=1/this.height;var d=new a.Matrix2D(e/this.aspect,0,0,e,0,0);var c=d.a*this.w/2+d.b*this.h/2;var b=d.c*this.w/2+d.d*this.h/2;if(this.align==a.VIEW_ALIGN_LEFT){d.tx=1-c}else{if(this.align==a.VIEW_ALIGN_RIGHT){d.tx=0-c}else{d.tx=0.5-c}}d.ty=0.5-b;return d};a.View.prototype.setInitView=function(){var c=(this.constrainWidth<1)?this.w*this.constrainWidth:this.w;var b=c/this.h;if(b>this.aspect){this.width=Math.round(this.aspect*this.h);this.height=this.h}else{this.width=c;this.height=Math.round(c/this.aspect)}if(this.maxHeight<this.height){if(this.devicePixelRatio&&this.devicePixelRatio!=1){this.w=Math.round(this.w/this.devicePixelRatio);this.h=Math.round(this.h/this.devicePixelRatio);this.devicePixelRatio=1;if(b>this.aspect){this.height=this.maxHeight<this.h?this.maxHeight:this.h;this.width=Math.round(this.aspect*this.height)}else{this.width=(this.constrainWidth<1)?this.w*this.constrainWidth:this.w;this.height=this.maxHeight<Math.round(this.width/this.aspect)?this.maxHeight:Math.round(this.width/this.aspect)}if(this.viewParent&&this.viewParent.adjustDevicePixelRatio){this.viewParent.adjustDevicePixelRatio()}}else{this.height=this.maxHeight;this.width=Math.round(this.aspect*this.height)}}var d=(this.zoomStep>0)?this.zoomStep:Math.log(2)/Math.log(this.maxHeight/this.h);this.zoomScale=Math.pow(2,1/d);if(this.elasticZoom<=0){this.scaleInc=Math.pow(2,1/(d*10))}else{this.scaleInc=Math.pow(2,1/(d))}};a.View.prototype.startTransition=function(){this.startViewToImage=this.viewToImage.clone();var b=new Date();this.startTime=b.getTime();this.prevStep=0;if(!this.inTransition){a.Util.timeout(a.View.transitionHandler,25,[this])}this.inTransition=true;if(this.viewParent!=null&&this.viewParent.viewTransitionStart!=null){this.viewParent.viewTransitionStart()}};a.View.transitionHandler=function(b){var c=false;c=b.onEnterFrame();if(c){a.Util.timeout(a.View.transitionHandler,25,[b])}};a.View.prototype.stopTransition=function(){if(this.inTransition){this.viewToImage=this.targetViewToImage.clone();this.inTransition=false;this.checkState();if(this.viewParent!=null&&this.viewParent.viewTransitionStop!=null){this.viewParent.viewTransitionStop()}}};a.View.prototype.stopAction=function(){this.stopTransition()};a.View.prototype.setViewPort=function(b){this.stopAction();this.viewToImage=this.zoomViewTransform(b);this.calcRes();this.invalidate(false)};a.View.prototype.onEnterFrame=function(){var b=new Date();var c=b.getTime();var k=(this.transitionTime!=0)?(c-this.startTime)/this.transitionTime:1;if(k>this.prevStep+this.maxStep){k=this.prevStep+this.maxStep}this.prevStep=k;if(k==0){return true}if(k>=1){this.viewToImage=this.targetViewToImage.clone();this.calcRes();this.invalidate(false);this.stopTransition();return false}if(this.transitionEasing==a.Enum.TRANSITION_EASING.AUTO){if(this.elasticZoom>0){if(this.transitionTime>=1500){k=(k*(k-2))*-1}else{if(this.transitionTime>1000){k=(k-=1)*k*k+1}else{if(this.transitionTime>500){k=((k-=1)*k*k*k-1)*-1}else{k=(k-=1)*k*k*k*k+1}}}}}else{if(this.transitionEasing==a.Enum.TRANSITION_EASING.QUADRATIC){k=(k*(k-2))*-1}else{if(this.transitionEasing==a.Enum.TRANSITION_EASING.CUBIC){k=(k-=1)*k*k+1}else{if(this.transitionEasing==a.Enum.TRANSITION_EASING.QUARTIC){k=((k-=1)*k*k*k-1)*-1}else{if(this.transitionEasing==a.Enum.TRANSITION_EASING.QUINTIC){k=(k-=1)*k*k*k*k+1}}}}}var j=1/k;var d=Math.exp(Math.log(this.targetViewToImage.d/this.startViewToImage.d)/j);var i;if(Math.abs(1-d)>1e-12){i=(1-Math.pow(d,j))/(1-d)}else{i=j}var h=(this.targetViewToImage.tx-this.startViewToImage.tx)/i;var g=(this.targetViewToImage.ty-this.startViewToImage.ty)/i;this.viewToImage=this.startViewToImage.clone();var f=this.viewToImage.tx;var e=this.viewToImage.ty;this.viewToImage.translate(-f,-e);this.viewToImage.scale(d,d);this.viewToImage.translate(f+h,e+g);this.calcRes();if((1-k)<0.1){this.invalidate(false)}else{this.invalidate(true)}this.checkState();return true};a.View.prototype.calcRes=function(){var c;var b=this.resolutions.length-1;if(this.viewToImage.a>this.viewToImage.d){c=this.viewToImage.a*this.resolutions[b].w}else{c=this.viewToImage.d*this.resolutions[b].h}while(c+a.View.epsilon1>2&&b>0){b--;c/=2}if(this.res){this.res.release()}this.res=this.resolutions[b]};a.View.prototype.invalidate=function(c){var e=this.delayTileLoad?this.delayTileLoad:a.Util.checkDefault(c,false);if(e==false&&this.tileRender&&this.resized==false&&Math.abs(this.viewToImage.d-this.initScale)<a.View.epsilon2){e=true}var d=new a.Rectangle(0,0,this.w,this.h);var b=this.viewToRes();d.x=Math.round(b.a*d.x+b.b*d.y+b.tx);d.y=Math.round(b.c*d.x+b.d*d.y+b.ty);d.width=Math.round(b.a*d.width+b.b*d.height);d.height=Math.round(b.c*d.width+b.d*d.height);this.res.invalidate(d,e?-1:0);this.invalidated=true;if(this.viewParent!=null){this.viewParent.viewInvalidate(this.getViewPort())}};a.View.intervalDraw=function(b){b.draw()};a.View.prototype.unload=function(b){if(b&8){if(this.drawInterval){clearInterval(this.drawInterval);this.drawInterval=null}this.resetImage.onload=function(){};this.resetImage.onerror=function(){};this.resetImage.onabort=function(){};this.resetImageLoaded=false}if(this.resolutions==null){return}if(b&1){for(var c=0;c<this.resolutions.length;c++){this.resolutions[c].release()}}};a.View.prototype.clampToImage=function(d){var f=this.h*d.d;var e=this.w*d.a;if(f<=1){d.ty=Math.max(d.ty,0);d.ty=Math.min(d.ty,1-f)}else{var b=d.d*this.h/2;d.ty=0.5-b}if(e<=1){d.tx=Math.max(d.tx,0);d.tx=Math.min(d.tx,1-e)}else{var c=d.a*this.w/2;if(this.align==a.VIEW_ALIGN_LEFT){d.tx=1-c;d.tx=Math.min(d.tx,0)}else{if(this.align==a.VIEW_ALIGN_RIGHT){d.tx=0-c;d.tx=Math.max(d.tx,1-e)}else{d.tx=0.5-c}}}};a.View.prototype.zoomViewTransform=function(j){var g=j.width*this.aspect;var c=j.height;var f;var k;var i=this.w;if((Math.abs(j.x-0)<a.View.epsilon2)&&(Math.abs(j.y-0)<a.View.epsilon2)&&(Math.abs(j.right-1)<a.View.epsilon2)&&(Math.abs(j.bottom-1)<a.View.epsilon2)){i=this.constrainWidth*i}if(i/this.h>g/c){k=j.height/this.h;f=k/this.aspect}else{f=j.width/i;k=f*this.aspect}var h=new a.Matrix2D(f,0,0,k,j.x,j.y);if(h.d<this.topScale){var b=this.topScale/h.d;var e=h.tx;var d=h.ty;h.translate(-e,-d);h.scale(b,b);h.translate(e,d)}this.clampToImage(h);return h};a.View.prototype.viewToRes=function(){var b=this.viewToImage.clone();b.scale(this.res.w,this.res.h);return b};a.View.prototype.getViewPort=function(){var b=new a.Rectangle(0,0,this.w,this.h);b.x=this.viewToImage.a*b.x+this.viewToImage.b*b.y+this.viewToImage.tx;b.y=this.viewToImage.c*b.x+this.viewToImage.d*b.y+this.viewToImage.ty;b.width=this.viewToImage.a*b.width+this.viewToImage.b*b.height;b.height=this.viewToImage.c*b.width+this.viewToImage.d*b.height;return b.intersection(new a.Rectangle(0,0,1,1))};a.View.prototype.imagePixelsToViewPoint=function(c){var d=this.viewToImage.clone();d.scale(this.imageWidth,this.imageHeight);d.invert();var b=d.transformPoint(c);b.x/=this.devicePixelRatio;b.y/=this.devicePixelRatio;return b};a.View.prototype.viewPointToImagePixels=function(d){var b=new a.Point2D(d.x*this.devicePixelRatio,d.y*this.devicePixelRatio);var c=this.viewToImage.clone();c.scale(this.imageWidth,this.imageHeight);return c.transformPoint(b)};a.View.prototype.zoomIn=function(){this.zoomClick(this.w/(2*this.devicePixelRatio),this.h/(2*this.devicePixelRatio),false)};a.View.prototype.zoomOut=function(){this.zoomClick(this.w/(2*this.devicePixelRatio),this.h/(2*this.devicePixelRatio),true)};a.View.prototype.zoomReset=function(){this.targetViewToImage=this.resetView();this.startTransition()};a.View.prototype.zoomNRgn=function(b){this.targetViewToImage=this.zoomViewTransform(b);this.startTransition()};a.View.prototype.zoomRgn=function(b){this.zoomNRgn(new a.Rectangle(b.x/this.imageWidth,b.y/this.imageHeight,b.width/this.imageWidth,b.height/this.imageHeight))};a.View.prototype.parentToClientX=function(c,d){var e=d.getBoundingClientRect();var b=c.clientX-e.left;return b};a.View.prototype.parentToClientY=function(c,d){var e=d.getBoundingClientRect();var b=c.clientY-e.top;return b}}})(s7getCurrentNameSpace());