/*!************************************************************************
*
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2011 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by trade secret or copyright law.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(function(b){b.Util.require("s7sdk.utils.SwatchesParser");if(!b.ItemDesc){b.ItemDesc=function ItemDesc(g,f,d,e){this.parent=g;this.type=f;this.name=d;this.swatch=e};b.ItemDesc.prototype.toString=function(){return this.name}}if(!b.ItemDescType){b.ItemDescType={UNKNOWN:0,IMG:1,VIDEO:2,IMAGE_SET:4,SPIN_SET:8,ECAT_SET:16,MEDIA_SET:32,EMPTY:64,VIDEO_SET:128,VIDEO_GROUP:256};b.ItemDescType.decodeItemDescType=function(d){switch(d){case"img":return b.ItemDescType.IMG;case"img_set":return b.ItemDescType.IMAGE_SET;case"spin":return b.ItemDescType.SPIN_SET;case"video":return b.ItemDescType.VIDEO;case"ecat":return b.ItemDescType.ECAT_SET;case"media_set":return b.ItemDescType.MEDIA_SET;case"empty":return b.ItemDescType.EMPTY;case"video_set":return b.ItemDescType.VIDEO_SET;case"video_group":return b.ItemDescType.VIDEO_GROUP}return b.ItemDescType.UNKNOWN}}if(!b.ImageDesc){b.ImageDesc=function ImageDesc(p,m,d,r,f,t,k,g,n,h,o,l,j,e,s,i,q){arguments.callee.superclass.call(this,p,m,d,r);this.isDefault=g;this.mod=(typeof(n)=="undefined"?null:n);this.pmod=(typeof(h)=="undefined"?null:h);this.label=o;this.width=f;this.height=t;this.version=k;this.maps=l;this.targets=j;this.userData=e;this.mapsuppressed=s;this.userdatasuppressed=i;this.np=q;this.images=null};b.Class.inherits("s7sdk.ImageDesc","s7sdk.ItemDesc");b.ImageDesc.createEmptyImageDesc=function c(f,e,d){return new b.ImageDesc(f,b.ItemDescType.EMPTY,null,null,e,d,null,false,null,null,null,null,null,null,true,false,true)}}if(!b.MapDesc){b.MapDesc=function MapDesc(e,g,i,d,f,h){this.shape=e;this.coords=g;this.alt=i;this.href=d;this.rolloverKey=f;this.target=h}}if(!b.MapDescShape){b.MapDescShape={SHAPE_RECT:"rect",SHAPE_CIRCLE:"circle",SHAPE_POLY:"poly"}}if(!b.MediaSetDesc){b.MediaSetDesc=function MediaSetDesc(g,h,f,d,e){arguments.callee.superclass.call(this,g,f,d,e);this.level=h;this.items=new Array();this.maps=null;this.targets=null;this.userdata=null};b.Class.inherits("s7sdk.MediaSetDesc","s7sdk.ItemDesc")}if(!b.VideoSetDesc){b.VideoSetDesc=function a(g,i,f,d,e,h){arguments.callee.superclass.call(this,g,i,f,d,e);this.image=h};b.Class.inherits("s7sdk.VideoSetDesc","s7sdk.MediaSetDesc")}if(!b.OrientationSetDesc){b.OrientationSetDesc=function OrientationSetDesc(d,e){arguments.callee.superclass.call(this,null,null,null,null);this.landscape=d;this.portrait=e?e:null;this.portraitTolandscapeHash=[];this.landscapeToportraitHash=[]};b.OrientationSetDesc.prototype.getPortraitIndex=function(d){return this.landscapeToportraitHash[d]};b.OrientationSetDesc.prototype.getLandscapeIndex=function(d){return this.portraitTolandscapeHash[d]};b.Class.inherits("s7sdk.OrientationSetDesc","s7sdk.ItemDesc")}if(!b.SwatchDesc){b.SwatchDesc=function SwatchDesc(h,e,f,d,g,i){this.image=h;this.color=e;this.label=f;this.mod=typeof(g)=="undefined"?null:g;this.pmod=typeof(i)=="undefined"?null:i;this.version=d;this.asset=null;this.frame=-1;this.sourceFrame=-1}}if(!b.TargetDesc){b.TargetDesc=function TargetDesc(f,h,g,e,d){this.frameId=h;this.index=f;this.rect=g;this.label=e;this.userdata=d}}if(!b.VideoDesc){b.VideoDesc=function VideoDesc(l,i,d,k,m,o,h,f,n,e,g,j){arguments.callee.superclass.call(this,l,i,d,m);this.suffix=o;this.version=h;this.width=f;this.height=n;this.userData=e;this.image=g;this.videoType=k;this.bitrate=j};b.Class.inherits("s7sdk.VideoDesc","s7sdk.ItemDesc")}if(!b.VideoDescType){b.VideoDescType={FILE:0,CATALOG_ID:1,PATH:2}}if(!b.MediaSetParser){b.MediaSetParser=function MediaSetParser(){};b.MediaSetParser.parse=function(f,g,d,e){return b.MediaSetParser.parseSet(null,f,0,null,g,d,e)};b.MediaSetParser.parseSet=function(m,f,e,n,o,l,g){if(o&&o.length>0){f.n+=(f.n.indexOf("?")==-1)?"?":"&";f.n+=o}var h;if(b.ItemDescType.decodeItemDescType(f.type)==b.ItemDescType.VIDEO_SET){var d=null;if(f.i){d=b.MediaSetParser.parseItemImage(null,f)}h=new b.VideoSetDesc(m,e,b.ItemDescType.decodeItemDescType(f.type),f.n,n,d)}else{h=new b.MediaSetDesc(m,e,b.ItemDescType.decodeItemDescType(f.type),f.n,n)}if(b.Util.isArray(f.item)){var k=f.item;for(var j=0;j<k.length;++j){h.items[j]=b.MediaSetParser.parseItem(h,k[j],e,o,l,g)}}else{h.items[0]=b.MediaSetParser.parseItem(h,f.hasOwnProperty("item")?f.item:f,e,o,l,g)}h.targets=b.MediaSetParser.parseTargets(f);h.maps=b.MediaSetParser.parseMaps(f);h.userdata=f.userdata;return h};b.MediaSetParser.parseItem=function(g,f,i,h,d,e){if(f.v!=undefined){return b.MediaSetParser.parseItemVideo(g,f,i,h,d)}else{if(f.set!=undefined){return b.MediaSetParser.parseItemSet(g,f,i,h,d,e)}else{if(f.i!=undefined){return b.MediaSetParser.parseItemImage(g,f,i,h,e)}}}};b.MediaSetParser.parseItemImage=function(p,e,d,t,f){var r=b.MediaSetParser.parseSwatch(e,e.iv,t,f);var n=b.MediaSetParser.parseMaps(e);var l=b.MediaSetParser.parseTargets(e);var s=(e.map=="1");var k=(e.userdata=="1");var q=(e.np=="1");if(b.Util.isArray(e.i)){var m=new Array();var i=new Array();for(var h=0;h<e.i.length;++h){m.push(new b.ImageDesc(null,b.ItemDescType.IMG,e.i[h].n,null,parseInt(e.dx),parseInt(e.dy),e.iv,e.i[h].isDefault,e.i[h].mod,e.i[h].pmod,e.i[h].l,null,null,null,false,false,false));i.push(e.i[h].n)}var o=new b.ImageDesc(p,e.type==undefined?b.ItemDescType.IMG:b.ItemDescType.decodeItemDescType(e.type),e.i[0].n,r,parseInt(e.dx),parseInt(e.dy),e.iv,e.i[0].isDefault,e.i[0].mod,e.i[0].pmod,e.i[0].l,n,l,e.userdata,(n&&f)?true:s,k,q);o.name=b.SwatchesParser.combinedImageName(i,f);if(t&&t.length>0){if(o.name.indexOf("?")){var g=o.name.substring(0,o.name.indexOf("?"));g+="?";g+=t+"&";o.name=g+o.name.substring(o.name.indexOf("?"))}}o.mod+="?";o.images=m;return o}else{if(t&&t.length>0){e.i.n+=(e.i.n.indexOf("?")==-1)?"?":"&";e.i.n+=t}return new b.ImageDesc(p,b.ItemDescType.IMG,e.i.n,r,parseInt(e.dx),parseInt(e.dy),e.iv,e.i.isDefault,e.i.mod,e.i.pmod,e.i.l,n,l,e.userdata,s,k,q)}};b.MediaSetParser.parseItemVideo=function(j,g,d,l,h){var k=b.MediaSetParser.parseSwatch(g,g.iv,l);var m=null;var f=g.v.name;var i=b.VideoDescType.FILE;if(h){if(g.v.path!=undefined){f=decodeURI(g.v.path);i=b.VideoDescType.PATH}else{if(g.v.id!=undefined){f=g.v.id;i=b.VideoDescType.CATALOG_ID}}}else{if(g.v.path!=undefined){f=g.v.path;i=b.VideoDescType.PATH}if(g.v.id!=undefined){f=g.v.id;i=b.VideoDescType.CATALOG_ID}}if(g.i!=undefined){m=b.MediaSetParser.parseItemImage(null,g)}b.Logger.log(b.Logger.FINER,"posterImage: "+(m!=null?m:"none"));var e=parseInt(g.v.bitrate)*(h?1024:1);return new b.VideoDesc(j,b.ItemDescType.VIDEO,f,i,k,g.v.suffix,g.iv,parseInt(g.v.dx),parseInt(g.v.dy),g.userdata,m,e)};b.MediaSetParser.resolveVideoAsset=function(i,h,e,f,g){var j=!f&&(i.name.indexOf("?")!=-1)?i.name.split("?")[0]:i.name;var d=(/^((http|https):\/\/[^\/]*)\b(\/DMGateway\/(private-ssl|private)\/)/.test(g));if(i.type==b.ItemDescType.VIDEO_GROUP&&f){if((b.browser.supportflash()&&(h.type=="flash"))||(h.type=="auto"&&!(/^((http|https):\/\/[^\/]*)\b(\/DMGateway\/(private-ssl|private)\/)/.test(g)))){throw new Error("Sets with type 'video_group'("+i.type+") could not be played by this video proxy.")}else{j=b.MediaSetParser.formNonAVS(i.items,e)}}else{if(!d&&(((b.browser.name=="safari")&&((("ipad"==b.browser.device.name)||("iphone"==b.browser.device.name))||((b.browser.device.name=="desktop")&&(((h.type!="flash")||(b.browser.version.minor>6))||(!b.browser.supportflash()&&h.type=="flash")))))||((b.browser.device.name=="blackberry")&&(b.browser.device.version==10)&&(!(b.browser.supportflash())||(h.type!="flash")))||((("ipad"==b.browser.device.name)||("iphone"==b.browser.device.name))&&(b.browser.name=="chrome"))||(h.type=="auto"&&((b.browser.name=="firefox"&&b.browser.version.minor>=45)||(b.browser.name=="ie"&&b.browser.version.minor>=11&&(typeof(MediaSource)!="undefined"))||(b.browser.device.name=="desktop"&&b.browser.name=="chrome")))||(h.type=="auto"&&b.browser.name=="ie"&&b.browser.version.minor>=11&&(typeof(MediaSource)!="undefined")))){if(i.videoType!=b.VideoDescType.PATH){j+=".m3u8"}}else{if((h.type!="flash"||d||b.browser.device.name=="android")&&(i.type==b.ItemDescType.VIDEO_SET)){j=b.MediaSetParser.getAssetByNearestBitrate(i.items,e)}}}return j};b.MediaSetParser.getAssetByNearestBitrate=function(l,k){var j,e;var d=-1;var h=-1;var f="";if(!l.length){f=l.name}else{for(j=0;j<l.length;j++){e=parseInt(l[j].bitrate);if((e<=k)&&(e>h)){d=e;h=e;f=l[j].name}}if(f==""){var g=-1;for(j=0;j<l.length;j++){e=parseInt(l[j].bitrate);if((g==-1)||(e<g)){g=e;f=l[j].name}}}}return f};b.MediaSetParser.formNonAVS=function(j,g){var k=Array.apply(this,j);var f=Array.apply(this,j);for(var e=f.length-1;e>=0;e--){if(f[e].suffix=="mp4"){f.splice(e,1)}}for(var e=k.length-1;e>=0;e--){if(k[e].suffix=="webm"){k.splice(e,1)}}var l=[],h=b.MediaSetParser.getAssetByNearestBitrate(f,g),d=b.MediaSetParser.getAssetByNearestBitrate(k,g);if(!b.Util.isNull(d)){l.push(d)}if(!b.Util.isNull(h)){l.push(h)}return l};b.MediaSetParser.parseItemSet=function(h,f,j,i,d,e){var g=b.MediaSetParser.parseSwatch(f,f.iv,i);return b.MediaSetParser.parseSet(h,f.set,j+1,g,i,d,e)};b.MediaSetParser.parseSwatch=function(f,d,g){if(f.s!=undefined){if(g&&g.length>0){f.s.n+=(f.s.n.indexOf("?")==-1)?"?":"&";f.s.n+=g}var e=f.s.n;return new b.SwatchDesc(e,f.s.c,f.s.l,d,f.s.mod,f.s.pmod)}return null};b.MediaSetParser.parseTargets=function(h){if(h.targets!=undefined&&h.targets.target!=undefined){var e=new Array();if(h.targets.target instanceof Array){for(var g=0;g<h.targets.target.length;g++){var f=h.targets.target[g];var k=(f.frame!=undefined&&f.frame!=""?f.frame:-1);var d=f.rect.split(",");var j=new b.Rectangle(parseInt(d[0]),parseInt(d[1]),parseInt(d[2]),parseInt(d[3]));e.push(new b.TargetDesc(f.number,k,j,f.label,f.userData))}}else{var f=h.targets.target;var k=(f.frame!=undefined&&f.frame!=""?f.frame:-1);var d=f.rect.split(",");var j=new b.Rectangle(parseInt(d[0]),parseInt(d[1]),parseInt(d[2]),parseInt(d[3]));e.push(new b.TargetDesc(f.number,k,j,f.label,f.userData))}return e}return null};b.MediaSetParser.parseMaps=function(e){var g=null;function f(k){var j=k.coords.split(",");for(var h=0;h<j.length;h++){j[h]=parseFloat(j[h])}return new b.MapDesc(k.shape,j,k.alt,k.href,k.rollover_key,k.target)}if(e.map&&e.map.area){g=[];if(b.Util.isArray(e.map.area)){for(var d=0;d<e.map.area.length;d++){g.push(f(e.map.area[d]))}}else{if(e.map.area.coords&&e.map.area.shape){g.push(f(e.map.area))}}}return g};b.MediaSetParser.findCompanyNameInAsset=function(d){var e=b.MediaSetParser.parseAssetForSetReq(d).name;return e};b.MediaSetParser.parseAssetForSetReq=function(l){function f(n){var o=n;var q;do{q=o;o=o.replace(/[\({][^{}\(\)]+[}\)]/g,function(r){return new Array(r.length+1).join("X")})}while(o!=q);var p=o.indexOf("?");if(p==-1){return{mainAssetPart:n,globalISModifier:null}}else{return{mainAssetPart:n.substring(0,p),globalISModifier:n.substring(p+1)}}}var j=l.match(/^[\{\(]?([^{\(\?\/]+)/);var m=j?j[1]:"";j=l.match(/^[{\(][^{}\(\)]+[}\)](?:,[{\(][^{}\(\)]+[}\)])+/);var h=j?j[0]:"";var e=f(l);var d=e.mainAssetPart;var g=e.globalISModifier;var i=(l.match(/^[{\(]/)||d.match(/[,:;]+/))?true:false;var k=(i&&((h.length>0)||d.match(/^[^{\(]/)))?true:false;if(i){if(k){req=m+"?req=set,json,UTF-8&imageSet=("+d+")"+((g)?"&"+g:"")}else{req=m+"?req=set,json,UTF-8&imageSet="+d+((g)?"&"+g:"")}}else{req=d+"?req=set,json,UTF-8"+((g)?"&"+g:"")}return{req:req,name:m,mod:g}}}if(!b.InteractiveSwatchDesc){b.InteractiveSwatchDesc=function InteractiveSwatchDesc(j,f,g,d,h,k,e,i){arguments.callee.superclass.apply(this,[j,f,g,d,h,k]);this.image=j;this.color=f;this.label=g;this.mod=typeof(h)=="undefined"?null:h;this.pmod=typeof(k)=="undefined"?null:k;this.version=d;this.href=typeof(e)=="undefined"?null:e;this.target=typeof(i)=="undefined"?null:i};b.Class.inherits("s7sdk.InteractiveSwatchDesc","s7sdk.SwatchDesc")}})(s7getCurrentNameSpace());