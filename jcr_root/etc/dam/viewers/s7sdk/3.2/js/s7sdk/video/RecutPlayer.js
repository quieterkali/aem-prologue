/*!************************************************************************
*
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2011 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by trade secret or copyright law.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(function(c){c.pkg("s7sdk.video");c.Util.require("s7sdk.common.IconEffect");if(!c.video.RecutPlayer){c.video.RecutPlayer=function RecutPlayer(o,m,t){arguments.callee.superclass.apply(this,[t,o,"div","s7videoplayer",m]);this.createElement();this.container=c.Util.byId(o);this.devicePixelRatio=window.hasOwnProperty("devicePixelRatio")?window.devicePixelRatio:1;this.view=null;this.videoServerUrl=this.getParam("videoserverurl","/e2/");if(this.videoServerUrl.lastIndexOf("/")!=(this.videoServerUrl.length-1)){this.videoServerUrl+="/"}this.compId=(c.Util.isNull(t)?"":t);this.videoAsset=unescape(this.getParam("asset",""));this.urlPrefix=this.getParam("urlprefix","");this.currentTime_=NaN;this.bufTime_=NaN;this.duration_=NaN;this.playing_=false;this.initialized_=false;var p=this.getParam("stagesize","0,0");this.wid=p.split(",")[0];this.hei=(p.split(",").length>=2?p.split(",")[1]:0);if(this.wid==0||this.hei==0){this.wid=parseInt(c.Util.css.getCss("s7videoplayer","width",this.compId,null,this.container));this.hei=parseInt(c.Util.css.getCss("s7videoplayer","height",this.compId,null,this.container));if(!c.Util.isNumber(this.wid)||!c.Util.isNumber(this.hei)||this.wid<=0||this.hei<=0){if("clientHeight" in this.container&&"clientWidth" in this.container){this.wid=this.container.clientWidth;this.hei=this.container.clientHeight}if(this.wid==0||this.hei==0){this.wid=400;this.hei=300}}}this.outWidth=this.wid*this.devicePixelRatio;this.outHeight=this.hei*this.devicePixelRatio;this.autoload=(this.getParam("autoload",1)==1);this.autoplay=(this.getParam("autoplay",1)==1);this.controls=(this.getParam("controls",0)==1);if(("ipad"==c.browser.device.name)||("iphone"==c.browser.device.name)||("android"==c.browser.device.name)){this.autoplay=false}this.clickToPlay=0;var r=this.getParam("singleclick","playPause");if((/play/i).test(r)){this.clickToPlay=1}var k=this.getParam("serverurl","/is/image/");if(k.lastIndexOf("/")!=(k.length-1)){k+="/"}var g=this.getParam("posterimage","");var f="";if(g==""||g.indexOf("?")==0){f=g;g=c.video.RecutPlayer.parseMovieUrl(this.videoAsset)}this.videoElement=c.Util.createObj(null,"video",null,null);this.videoElement.width=this.outWidth;this.videoElement.height=this.outHeight;this.videoElement.preload=(this.autoload?"auto":"metadata");if(g!="none"){this.videoElement.poster=k+g+(f!=""?f:"?fit=constrain&wid="+this.wid+"&hei="+this.hei)}if(this.autoplay){this.videoElement.autoplay=true}if(this.controls){this.videoElement.controls=true}else{if("android"==c.browser.device.name){this.videoElement.controls=false}}this.videoElement.style.width=this.wid+"px";this.videoElement.style.height=this.hei+"px";var s=document.createElement("source");s.src=this.videoServerUrl+this.videoAsset+".mp4";this.videoElement.appendChild(s);if(this.clickToPlay){this.addEventListener("click",function(){this.togglePause()});this.addEventListener("touchstart",function(){this.togglePause()})}this.obj.appendChild(this.videoElement);if(this.container.firstChild){this.container.replaceChild(this.obj,this.container.firstChild)}else{this.container.appendChild(this.obj)}this.iconEffect=new c.IconEffect(this.obj,m);if(this.autoplay){this.iconEffect.hide()}else{if(this.iconEffect.enabled){this.iconEffect.show(this.wid,this.hei)}}var n=this;this.overlayLayer=c.Util.createObj("s7recutoverlays","div",null,"s7recutoverlays");this.overlayLayer.style.position="absolute";this.overlayLayer.style.left="0px";this.overlayLayer.style.top="0px";this.overlayLayer.style.width=this.videoElement.style.width;this.overlayLayer.style.height=this.videoElement.style.height;this.overlayLayer.style.zindex=5;this.overlayLayer.style.overflow="hidden";this.obj.appendChild(this.overlayLayer);this.globalLayer=c.Util.createObj("s7globaloverlays","div",null,"s7globaloverlays");this.globalLayer.style.position="absolute";this.globalLayer.style.left="0px";this.globalLayer.style.top="0px";this.globalLayer.style.width=this.videoElement.style.width;this.globalLayer.style.height=this.videoElement.style.height;this.globalLayer.style.zindex=5;this.globalLayer.style.overflow="hidden";this.obj.appendChild(this.globalLayer);this.loadRecutXML(this.videoServerUrl+this.videoAsset+".xml",l);this.currentInstance=null;function l(){n.parseRecutXML(this.responseXML)}this.checkRate=100;function h(){var v=0;if(n.videoElement.buffered&&n.videoElement.buffered.length>0){n.videoElement.buffered.end(0)}if((!isNaN(v))&&(v!=n.bufTime_)){n.bufTime_=v;var x=new c.event.VideoEvent(c.event.VideoEvent.NOTF_LOAD_PROGRESS,v*1000,true);c.Event.dispatch(n.obj,x,false)}var z=n.videoElement.currentTime;if((!isNaN(z))&&(z!=n.currentTime_)){n.currentTime_=z;var w=new c.event.VideoEvent(c.event.VideoEvent.NOTF_CURRENT_TIME,z*1000,true);c.Event.dispatch(n.obj,w,false);if(n.initialized_){var u=n.getInstanceAtTime(z*1000);if(u!=n.currentInstance){n.currentInstance=u;n.renderInstance(u,n.overlayLayer)}}}z=n.videoElement.duration;if((!isNaN(z))&&(z!=n.duration_)){n.duration_=z;w=new c.event.VideoEvent(c.event.VideoEvent.NOTF_DURATION,z*1000,true);c.Event.dispatch(n.obj,w,false)}if(n.playing_&&n.ended()){n.playing_=false;if(n.iconEffect.enabled){n.iconEffect.show(this.wid,this.hei)}var y=new c.UserEvent(c.UserEvent.STOP,n.videoElement.currentTime,true);c.Event.dispatch(n.obj,y,false)}}this.playTimer=setInterval(h,this.checkRate);this.playing_=(this.autoplay?true:false);var q=new c.UserEvent(this.autoplay?c.UserEvent.PLAY:c.UserEvent.PAUSE,this.videoElement.currentTime,true);c.Event.dispatch(this.obj,q,false)};c.Class.inherits("s7sdk.video.RecutPlayer","s7sdk.UIComponent");c.video.RecutPlayer.prototype.addEventListener=function(h,g,f){c.Event.addEventHandler(this.obj,h,this,g,f)};c.video.RecutPlayer.prototype.resize=function(f,g){if(f==this.wid&&g==this.hei){return}this.wid=f>0?f:1;this.hei=g>0?g:1;this.outWidth=this.wid*this.devicePixelRatio;this.outHeight=this.hei*this.devicePixelRatio;this.videoElement.width=this.outWidth;this.videoElement.height=this.outHeight;this.videoElement.style.width=this.wid+"px";this.videoElement.style.height=this.hei+"px";if(this.iconEffect.enabled){this.iconEffect.centerOverlay(f,g)}c.UIComponent.prototype.resize.apply(this,[f,g])};c.video.RecutPlayer.prototype.getAsset=function(){return this.videoAsset};c.video.RecutPlayer.prototype.setAsset=function(f){this.videoAsset=f;if(this.videoElement){while(this.videoElement.firstChild){this.videoElement.removeChild(this.videoElement.firstChild)}var g=document.createElement("source");g.src=this.videoServerUrl+this.videoAsset;this.videoElement.appendChild(g)}};c.video.RecutPlayer.prototype.getVolume=function(){return(this.videoElement?this.videoElement.volume:0)};c.video.RecutPlayer.prototype.setVolume=function(f){if(this.videoElement){this.videoElement.volume=f}};c.video.RecutPlayer.prototype.getCurrentTime=function(){return(this.videoElement?this.videoElement.currentTime*1000:0)};c.video.RecutPlayer.prototype.getLoadedPosition=function(){return((this.videoElement&&this.videoElement.buffered&&this.videoElement.buffered.length>0)?this.videoElement.buffered.end(0)*1000:0)};c.video.RecutPlayer.prototype.getDuration=function(){return(this.videoElement?this.videoElement.duration*1000:0)};c.video.RecutPlayer.prototype.muted=function(){return(this.videoElement?this.videoElement.muted:0)};c.video.RecutPlayer.prototype.paused=function(){return(this.videoElement?this.videoElement.paused:0)};c.video.RecutPlayer.prototype.ended=function(){return(this.videoElement?this.videoElement.ended:0)};c.video.RecutPlayer.prototype.supportsFullScreen=function(){if(("ipad"==c.browser.device.name)||("safari"==c.browser.name)||("chrome"==c.browser.name)){return(this.videoElement?this.videoElement.webkitSupportsFullscreen:false)}return false};c.video.RecutPlayer.prototype.enterFullScreen=function(){if(this.videoElement&&this.videoElement.webkitSupportsFullscreen){this.videoElement.webkitEnterFullScreen()}};c.video.RecutPlayer.prototype.play=function(){if(this.videoElement){this.videoElement.play();this.playing_=true;this.iconEffect.hide();var f=new c.UserEvent(c.UserEvent.PLAY,this.videoElement.currentTime,true);c.Event.dispatch(this.obj,f,false)}};c.video.RecutPlayer.prototype.pause=function(){if(this.videoElement){this.videoElement.pause();this.playing_=false;if(this.iconEffect.enabled){this.iconEffect.show(this.wid,this.hei)}var f=new c.UserEvent(c.UserEvent.PAUSE,this.videoElement.currentTime,true);c.Event.dispatch(this.obj,f,false)}};c.video.RecutPlayer.prototype.togglePause=function(){if(this.videoElement){if(this.videoElement.paused){this.play()}else{this.pause()}}};c.video.RecutPlayer.prototype.seek=function(f){if(this.videoElement){this.videoElement.currentTime=f/1000}};c.video.RecutPlayer.prototype.mute=function(){if(this.videoElement){this.videoElement.muted=true}};c.video.RecutPlayer.prototype.unmute=function(){if(this.videoElement){this.videoElement.muted=false}};c.video.RecutPlayer.prototype.loadRecutXML=function(f,h){var g=new XMLHttpRequest();g.onreadystatechange=function(){if(g.readyState===4){h.apply(g)}};g.open("GET",f,true);g.send(null)};c.video.RecutPlayer.prototype.parseRecutXML=function(m){var p=m.getElementsByTagName("remix");if(p.length>0){var h=p[0].getElementsByTagName("info");var g=p[0].getElementsByTagName("assets");var l=g[0].getElementsByTagName("asset");this.assets=new Array();for(i=0;i<l.length;i++){this.assets.push(new c.video.RecutAsset(c.video.RecutPlayer.getIntegerValue(l[i],"id"),c.video.RecutPlayer.getStringValue(l[i],"type"),c.video.RecutPlayer.getStringValue(l[i],"url")))}var n=p[0].getElementsByTagName("sequence");var o=n[0].getElementsByTagName("track");this.tracks=new Array();var k=o[0].getElementsByTagName("instance");var f=new Array();this.tracks.push(f);for(i=0;i<k.length;i++){var q=this.parseInstance(k[i]);f.push(q)}k=o[2].getElementsByTagName("instance");f=new Array();this.tracks.push(f);for(i=0;i<k.length;i++){var q=this.parseInstance(k[i]);f.push(q);this.renderInstance(q,this.globalLayer)}this.initialized_=true}};c.video.RecutPlayer.prototype.parseInstance=function(l){var g=new c.video.RecutInstance(c.video.RecutPlayer.getIntegerAttr(l,"start"),c.video.RecutPlayer.getIntegerAttr(l,"duration"));var f=l.getElementsByTagName("content");for(j=0;j<f.length;j++){var k=new c.video.RecutContent(c.video.RecutPlayer.getIntegerAttr(f[j],"asset"),c.video.RecutPlayer.getStringAttr(f[j],"type"),f[j].getElementsByTagName("transform"));g.contents.push(k);if(k.type=="ComplexCaption"){k.text=c.video.RecutPlayer.getStringValue(f[j],"text")}else{if(k.type=="ImageContent"){var h=f[j].getElementsByTagName("box");if(h&&h.length>0){k.width=c.video.RecutPlayer.getFloatValue(h[0],"width");k.height=c.video.RecutPlayer.getFloatValue(h[0],"height")}}}}return g};c.video.RecutPlayer.prototype.getInstanceAtTime=function(h){for(var g=0;g<this.tracks[0].length;++g){var f=this.tracks[0][g];if((h>=f.start)&&(h<f.start+f.duration)){return f}}};c.video.RecutPlayer.prototype.renderInstance=function(f,h){var k;while(k=h.firstChild){h.removeChild(k)}for(var g=0;g<f.contents.length;++g){this.renderContent(f.contents[g],h)}};c.video.RecutPlayer.prototype.renderContent=function(k,g){var f;var h;if(k.type=="ImageContent"){h=this.getAsset(k.asset);if(h){f=new Image();f.src=this.urlPrefix+h.url;f.style.position="absolute";f.style.left=Math.round(k.x)+"px";f.style.top=Math.round(k.y)+"px";f.style.width=Math.round(k.width)+"px";f.style.height=Math.round(k.height)+"px";g.appendChild(f)}}else{if(k.type=="BorderContent"){h=this.getAsset(k.asset);if(h&&(h.url.lastIndexOf(".png")==h.url.length-4)){f=new Image();f.src=this.urlPrefix+h.url;f.style.position="absolute";f.style.left="0px";f.style.top="0px";f.style.width=this.wid+"px";f.style.height=this.hei+"px";g.appendChild(f)}}else{if(k.type=="ComplexCaption"){h=this.getAsset(k.asset);if(h){f=c.Util.createObj(null,"div",null,null);f.style.position="absolute";f.style.left=Math.round(k.x)+"px";f.style.top=Math.round(k.y)+"px";f.style.font="bold 18px arial,sans-serif";f.innerHTML=k.text;g.appendChild(f)}}}}};c.video.RecutPlayer.prototype.getAsset=function(g){for(var f=0;f<this.assets.length;++f){if(this.assets[f].id==g){return this.assets[f]}}return null};c.video.RecutPlayer.getIntegerValue=function(g,f){return parseInt(g.getElementsByTagName(f)[0].textContent)};c.video.RecutPlayer.getFloatValue=function(g,f){return parseFloat(g.getElementsByTagName(f)[0].textContent)};c.video.RecutPlayer.getStringValue=function(g,f){return g.getElementsByTagName(f)[0].textContent};c.video.RecutPlayer.getIntegerAttr=function(h,g){var f=h.attributes[g];return(f?parseInt(f.value):0)};c.video.RecutPlayer.getStringAttr=function(h,g){var f=h.attributes[g];return(f?f.value:"")};c.video.RecutPlayer.parseMovieUrl=function(g){var f=null;if(g){f=g.replace(/[\\]/g,"/");ar=f.split(".");if(ar.length>1){f=ar[0]}ar=f.split(":");if(ar.length>1){f=ar[1]}ar=f.split("/");f=ar.length>1?ar[0]+"/"+ar[ar.length-1]:f}return f};c.RecutPlayer=c.video.RecutPlayer;(function b(){var h=c.Util.css.createCssRuleText;var g=c.Util.css.createCssImgUrlText;var f=h(".s7videoplayer .s7iconeffect",{width:"120px",height:"120px","-webkit-transform":"translateZ(0px)","background-repeat":"no-repeat","background-position":"center","background-image":g("videoplayicon.png")});c.Util.css.addDefaultCSS(f,"RecutPlayer")})()}if(!c.video.RecutAsset){c.video.RecutAsset=function a(h,g,f){this.id=h;this.type=g;this.url=f};c.RecutAsset=c.video.RecutAsset}if(!c.video.RecutInstance){c.video.RecutInstance=function d(g,f){this.start=g;this.duration=f;this.contents=new Array()};c.RecutInstance=c.video.RecutInstance}if(!c.video.RecutContent){c.video.RecutContent=function e(k,h,g){this.asset=k;this.type=h;this.x=0;this.y=0;this.scalex=1;this.scaley=1;if(g&&g.length>0){var f=g[0].getElementsByTagName("matrix");if(f&&f.length>0){this.x=c.video.RecutPlayer.getFloatValue(f[0],"tx");this.y=c.video.RecutPlayer.getFloatValue(f[0],"ty");this.scalex=c.video.RecutPlayer.getFloatValue(f[0],"a");this.scaley=c.video.RecutPlayer.getFloatValue(f[0],"d")}}};c.RecutContent=c.video.RecutContent}})(s7getCurrentNameSpace());