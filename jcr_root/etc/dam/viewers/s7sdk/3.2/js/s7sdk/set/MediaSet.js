/*!************************************************************************
*
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2011 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by trade secret or copyright law.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(function(a){a.pkg("s7sdk.set");a.Util.require("s7sdk.common.Geometry");a.Util.require("s7sdk.common.IS");a.Util.require("s7sdk.common.ItemDesc");a.Util.require("s7sdk.utils.SwatchesParser");a.Util.require("s7sdk.event.Event");if(!a.set.MediaSetControl){a.set.MediaSetControl=function(b){arguments.callee.superclass.apply(this,[b,a.set.MediaSetControl.NS,b.constructor,a.set.MediaSet.RESTRICTED_STYLES])};a.set.MediaSetControl.NS="s7sdk.set.MediaSetControl";a.set.MediaSetControl.prototype.setModifier=function(b){var e="";var o=this.component.getModifiers();var q=this.component.settings;var n=false;var p={};for(var l in b){var r=l.toLowerCase();p[r]=b[l]}var f=p.asset;var h=(f?f:this.component.asset);var j=false;for(var g in o){var d=g.toLowerCase();var m;if(p[d]){if(d=="serverurl"){a.Logger.log(a.Logger.INFO,"s7sdk.set.MediaSet setModifier - unsupported modifier: %0",g);continue}m=p[d];if(d=="enableorientation"&&this.component.jsonSet){var c=m.toString().toLowerCase();if(c=="1"||c=="true"||c=="false"||c=="0"){this.component.enableOrientation=c=="1"||c=="true";this.component.requestComplete({set:this.component.jsonSet},this.component)}else{continue}}else{if(d=="asset"&&m&&m!=""){e=this.component.asset;n=true;j=true}else{if(d=="labelkey"&&m){e=this.component.labelKey;this.component.labelKey=m;n=true}else{if(d=="flattensets"&&m){var c=m.toString().toLowerCase();if(c=="1"||c=="true"||c=="false"||c=="0"||(c.split(",").length>1)){e=this.component.flattenSets.enabled+","+this.component.flattenSets.ignoreSwatches;if(c.split(",").length>1){this.component.flattenSets.enabled=c.split(",")[0]==("1"||"true")?true:false;this.component.flattenSets.ignoreSwatches=c.split(",")[1]==("1"||"true")?true:false}else{this.component.flattenSets.enabled=c==("1"||"true")?true:false;this.component.flattenSets.ignoreSwatches=false}this.component.requestComplete({set:this.component.jsonSet},this.component)}else{continue}}}}}this.dispatchEvent(new a.event.ControlComponentEvent(a.event.ControlComponentEvent.NOTF_CONTROLCOMPONENT_MODIFIERUPDATED,{id:this.component.getId(),oldvalue:e,newvalue:m,property:d},false))}}if(n){this.component.setAssetInternal(h,j)}};a.set.MediaSetControl.prototype.unload=function(){}}a.Class.inherits(a.set.MediaSetControl.NS,"s7sdk.ControlComponent");if(!a.set.MediaSet){a.set.MediaSet=function MediaSet(b,d,c){var e=!!arguments[3];a.Logger.log(a.Logger.CONFIG,"s7sdk.set.MediaSet constructor - containerId: %0, settings: %1 , compId: %2",b,d,c);arguments.callee.superclass.apply(this,[c,b,"div","s7mediaset",d,!e]);this.createElement();this.mediaSetDesc=null;this.globalISModifier=null;this.locale=this.getParam("locale","");this.dir=this.direction=="auto"?this.locale=="ja":this.direction!="left";if(this.serverUrl.lastIndexOf("/")!=(this.serverUrl.length-1)){this.serverUrl+="/"}if(typeof(this.asset)=="string"&&this.asset.length>0){this.requestMediaSet()}if(!e){return new a.set.MediaSetControl(this)}else{return this}};a.Class.inherits("s7sdk.set.MediaSet","s7sdk.UIComponent");a.set.MediaSet.prototype.symbols={};a.set.MediaSet.prototype.modifiers={asset:{params:["asset"],defaults:[""],parseParams:false},serverUrl:{params:["isRootPath"],defaults:["/is/image/"]},direction:{params:["direction"],defaults:["auto"],ranges:[["auto","left","right"]]},enableOrientation:{params:["value"],defaults:[false],ranges:[[true,false]]},labelKey:{params:["key"],defaults:["label"]},aemmode:{params:["value"],defaults:[false],ranges:[[true,false]]},flattenSets:{params:["enabled","ignoreSwatches"],defaults:[false,false]}};a.set.MediaSet.prototype.setAsset=function(b){this.setAssetInternal(b,true)};a.set.MediaSet.prototype.setAssetInternal=function(b,c){a.Logger.log(a.Logger.FINE,"s7sdk.set.MediaSet.setAsset - asset: %0",b);this.blockLabels=c;b=b.toString();if(b==""||b==null){return}if(b!=null&&this.asset!=null&&this.asset!=""){var d=decodeURIComponent(b).split("/",2);var e=(d.length==2)?d[1]:d[0];this.dispatchEvent(new a.event.UserEvent(a.event.UserEvent.SWAP,[0,e]))}this.asset=b;this.requestMediaSet()};a.set.MediaSet.prototype.addEventListener=function(d,c,b){a.Logger.log(a.Logger.FINE,"s7sdk.set.MediaSet.addEventListener - type: %0, handler: %1, useCapture: %2",d,c.toString().substring(0,c.toString().indexOf("(")),b);this.superproto.addEventListener.apply(this,[d,c,b])};a.set.MediaSet.prototype.requestMediaSet=function(){a.Logger.log(a.Logger.INFO,"MediaSet.requestMediaSet");this.mediaSet_=this.asset;var c=this.serverUrl;if(c.lastIndexOf("/")<(c.length-1)){c+="/"}var b=a.MediaSetParser.parseAssetForSetReq(this.asset);this.globalISModifier=b.mod;if(this.aemmode){c+=this.asset;c+=(c.indexOf("?")==-1)?"?":"&";c+="req=set,json,UTF-8"}else{c+=b.req}if(a.Util.isNonEmptyString(this.labelKey)){c+="&labelkey="+this.labelKey}if(a.Util.isNonEmptyString(this.locale)){c+="&locale="+this.locale}this.isReq_=new a.IS(this.serverUrl,this.mediaSet_);this.isReq_.getHttpReq(c,this.requestComplete,this.requestError,this)};a.set.MediaSet.prototype.requestComplete=function(c,g){var b=c.set;if(b==null){return}g.jsonSet=c.set;var j=a.MediaSetParser.parse(b,g.aemmode?undefined:g.globalISModifier,g.aemmode,g.dir);if(g.aemmode&&j.type==a.ItemDescType.SPIN_SET&&j.items.length==1){var h=new a.MediaSetDesc(j.parent,j.level,j.type,j.name,j.swatch);for(var e=0;e<j.items[0].items.length;e++){h.items.push(j.items[0].items[e])}j=h}else{if(g.flattenSets.enabled){var h=new a.MediaSetDesc(j.parent,j.level,j.type,j.name,j.swatch);for(var e=0;e<j.items.length;e++){if(j.items[e].type==a.ItemDescType.IMAGE_SET){for(var d=0;d<j.items[e].items.length;d++){if(g.flattenSets.ignoreSwatches){if(j.items[e].items[d].swatch){j.items[e].items[d].swatch.image=j.items[e].items[d].name}}h.items.push(j.items[e].items[d])}}else{h.items.push(j.items[e])}}j=h}}g.mediaSetDesc_=g.enableOrientation?a.set.MediaSet.prototype.createSplitFramesMediaSet(j,true):j;if(g.updateLandscapeLabels){g.updateLabels()}var f=new a.event.AssetEvent(a.event.AssetEvent.NOTF_SET_PARSED,g.mediaSetDesc_,0,true);g.dispatchEvent(f)};a.set.MediaSet.prototype.setMediaSetData=function(c){if(c){var b={};b.set=c;this.requestComplete(b,this)}};a.set.MediaSet.prototype.updateLabels=function(){this.updateLandscapeLabels();this.updatePortraitLabels()};a.set.MediaSet.prototype.updateLandscapeLabels=function(){var j=this.mediaSetDesc_.landscape?this.mediaSetDesc_.landscape.items:this.mediaSetDesc_.items;var b=this.getLocalizedText("LABEL_DELIM");b=b&&!this.blockLabels?b:" - ";for(var g=0;g<j.length;g++){var m=j[g];var k=g.toString();var e=m.label;var h=undefined;var f=undefined;if(m.images){e=undefined;if(m.images[0].label){h=m.images[0].label}if(m.images[1]&&m.images[1].label){f=m.images[1].label}}var n=this.blockLabels?null:this.getLocalizedText("LABEL_"+k);var d=this.blockLabels?null:this.getLocalizedText("LABEL_"+k+"_0");var c=this.blockLabels?null:this.getLocalizedText("LABEL_"+k+"_1");var l=undefined;if(!m.np){if(n){l=n}else{if(d){l=d;if(c){l+=b+c}}else{if(e){l=e}else{if(h){l=h;if(f){l+=b+f}}else{if(f){l=f}}}}}}else{if(n){l=n}else{if(d){l=d}else{if(e){l=e}}}}m.label=l}};a.set.MediaSet.prototype.updatePortraitLabels=function(){if(!this.mediaSetDesc_.portrait){return}var g=this.mediaSetDesc_.portrait.items;var b=null;var c=false;var e=0;for(var f=0;f<g.length;f++){var j=g[f];if(f==0&&j.halfFrame){c=true}b=((c?f:f-1)&1)==0?"_0":"_1";var d=null;var h=e.toString();var k=this.getLocalizedText("LABEL_"+h);if(b=="_0"){d=this.getLocalizedText("LABEL_"+h+"_0")}else{d=this.getLocalizedText("LABEL_"+h+"_1");e++}if(d){j.label=d}else{if(k){j.label=k}}}};a.set.MediaSet.prototype.requestError=function(b,c){a.Logger.log(a.Logger.WARNING,"s7sdk.set.MediaSet.requestError - response: %0",b)};a.set.MediaSet.prototype.setModifier=function(b){throw new Error("Trying to use setModifier on the Core class (MediaSet) is unsupported! Please refer to SDK documentation on using setModifier.")};a.set.MediaSet.prototype.cloneImageDesc=function(b,d){var c=new a.ImageDesc(b,d.type,d.name,d.swatch);c.isDefault=d.isDefault;c.mod=d.mod;c.pmod=d.pmod;c.label=d.label;c.width=d.width;c.height=d.height;c.version=d.version;c.maps=d.maps;c.targets=d.targets;c.userData=d.userData;c.mapsuppressed=d.mapsuppressed;c.userdatasuppressed=d.userdatasuppressed;c.np=d.np;c.images=d.images;return c};a.set.MediaSet.prototype.createSplitFramesMediaSet=function(n,c){var m=new a.MediaSetDesc(n.parent,n.level,n.type,n.name,n.swatch);this.maps=n.maps;this.targets=n.targets;this.userdata=n.userdata;var l=new a.OrientationSetDesc(n,m);l.portraitTolandscapeHash=new Object();l.landscapeToportraitHash=new Object();if(!c||!(n.type===a.ItemDescType.ECAT_SET)){for(var h=0;h<n.items.length;h++){var p=n.items[h];m.items.push(p);l.portraitTolandscapeHash[h]=l.landscapeToportraitHash[h]=h}l.splitted=false;return l}var b=0;for(var h=0;h<n.items.length;h++){var p=n.items[h];if(!p.np){if(p.images&&p.images.length==2){var g=Math.round(p.width/2);var d=this.cloneImageDesc(m,p.images[0]);d.np=true;d.width=g;d.mapsuppressed=(p.mapsuppressed||(p.maps&&p.maps.length))?true:false;m.items.push(d);m.items[m.items.length-1].halfFrame=true;l.portraitTolandscapeHash[b]=h;l.landscapeToportraitHash[h]=b;b++;d=this.cloneImageDesc(m,p.images[1]);d.np=true;d.width=g;d.mapsuppressed=(p.mapsuppressed||(p.maps&&p.maps.length))?true:false;m.items.push(d);m.items[m.items.length-1].halfFrame=true}else{var o=p.name.split("?")[0].split("/")[0];var g=Math.round(p.width/2);var k=o+"?src=is("+p.name+(p.name.indexOf("?")==-1?"?":"&")+"rgn=0,0,"+g+","+p.height+")";var j=o+"?src=is("+p.name+(p.name.indexOf("?")==-1?"?":"&")+"rgn="+g+",0,"+g+","+p.height+")";var f,e;e=f=p.label;if(p.images){e=undefined;if(p.images[0].label){f=p.images[0].label}if(p.images[1]&&p.images[1].label){e=p.images[1].label}}m.items.push(new a.ImageDesc(m,p.type,k,null,g,p.height,p.version,p.isDefault,p.mod,p.pmod,f,null,null,null,(p.mapsuppressed||(p.maps&&p.maps.length))?true:false,false,true));m.items[m.items.length-1].halfFrame=true;l.portraitTolandscapeHash[b]=h;l.landscapeToportraitHash[h]=b;b++;m.items.push(new a.ImageDesc(m,p.type,j,null,g,p.height,p.version,p.isDefault,p.mod,p.pmod,e,null,null,null,(p.mapsuppressed||(p.maps&&p.maps.length))?true:false,false,true));m.items[m.items.length-1].halfFrame=true}l.portraitTolandscapeHash[b]=h;b++}else{m.items.push(this.cloneImageDesc(m,p));l.landscapeToportraitHash[h]=b;l.portraitTolandscapeHash[b]=h;b++}}l.splitted=true;return l};a.set.MediaSet.prototype.dispose=function(){if(this.isReq_){this.isReq_.cancelHttpReq();this.isReq_=null}if(this.obj.parentElement){this.obj.parentElement.removeChild(this.obj)}};a.MediaSet=a.set.MediaSet}})(s7getCurrentNameSpace());